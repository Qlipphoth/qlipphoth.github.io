<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Unity 补完计划（四）：UGUI-1：EventSystem | Qliphoth's Blog</title><meta name="author" content="Qliphoth"><meta name="copyright" content="Qliphoth"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="EventSystem Unity 的 UGUI 系统中的 EventSystem 是一个核心组件，用于管理和处理用户输入事件。它是所有 UI 交互的基础，负责检测和分发输入事件，如鼠标点击、触摸、键盘输入等。EventSystem 的主要功能包括：   管理所有的输入检测模块（InputModule）。 EventSystem 使用输入模块（Input Modules）来处理不同类型的输入并逐帧">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity 补完计划（四）：UGUI-1：EventSystem">
<meta property="og:url" content="https://qlipphoth.github.io/2024/08/27/2024-8-27-1/index.html">
<meta property="og:site_name" content="Qliphoth&#39;s Blog">
<meta property="og:description" content="EventSystem Unity 的 UGUI 系统中的 EventSystem 是一个核心组件，用于管理和处理用户输入事件。它是所有 UI 交互的基础，负责检测和分发输入事件，如鼠标点击、触摸、键盘输入等。EventSystem 的主要功能包括：   管理所有的输入检测模块（InputModule）。 EventSystem 使用输入模块（Input Modules）来处理不同类型的输入并逐帧">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg">
<meta property="article:published_time" content="2024-08-27T13:25:27.000Z">
<meta property="article:modified_time" content="2025-01-14T10:20:41.000Z">
<meta property="article:author" content="Qliphoth">
<meta property="article:tag" content="Unity">
<meta property="article:tag" content="C#">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg"><link rel="shortcut icon" href="https://s2.loli.net/2023/08/12/NkcT1PLmZVj5iY3.png"><link rel="canonical" href="https://qlipphoth.github.io/2024/08/27/2024-8-27-1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":500,"languages":{"author":"Author: Qliphoth","link":"Link: ","source":"Source: Qliphoth's Blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Unity 补完计划（四）：UGUI-1：EventSystem',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-14 10:20:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 10 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom/beauty.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/hexo-electric-clock@1.0.6/clock.css"><link rel="stylesheet" href="/css/runtime.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2023/08/12/NkcT1PLmZVj5iY3.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">131</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">22</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/talk/"><i class="fa-fw fas fa-comment-dots"></i><span> Talk</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw far fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Qliphoth's Blog"><span class="site-name">Qliphoth's Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/talk/"><i class="fa-fw fas fa-comment-dots"></i><span> Talk</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw far fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Unity 补完计划（四）：UGUI-1：EventSystem</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-08-27T13:25:27.000Z" title="Created 2024-08-27 13:25:27">2024-08-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-01-14T10:20:41.000Z" title="Updated 2025-01-14 10:20:41">2025-01-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Unity/">Unity</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Unity/UGUI/">UGUI</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">16.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>78min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Unity 补完计划（四）：UGUI-1：EventSystem"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>EventSystem</h1>
<p>Unity 的 UGUI 系统中的 <code>EventSystem</code> 是一个核心组件，用于管理和处理用户输入事件。它是所有 UI 交互的基础，负责检测和分发输入事件，如鼠标点击、触摸、键盘输入等。<code>EventSystem</code> 的主要功能包括：</p>
<ol>
<li>
<p>管理所有的输入检测模块（<code>InputModule</code>）。 <code>EventSystem</code> 使用输入模块（Input Modules）来处理不同类型的输入并逐帧调用 Module 的执行函数 <code>Process()</code>，常见的输入模块包括 <code>StandaloneInputModule</code>（用于鼠标和键盘输入）和 <code>TouchInputModule</code>（用于触摸输入）。</p>
</li>
<li>
<p>调动射线捕捉模块（<code>Raycasters</code>），为 <code>InputModule</code> 提供结果（具体的触点所穿透的对象信息）。 <code>EventSystem</code> 使用射线检测（Raycasting）来确定用户输入的位置和目标。它会发射一条射线，从输入设备（如鼠标或触摸点）的位置出发，检测与之相交的 UI 元素，并将事件传递给 UI 元素。</p>
</li>
<li>
<p>事件监听及处理（<code>ExecuteEvent</code>）。 <code>EventSystem</code> 会捕获用户的输入事件，生成对应的 <code>EventData</code> 并将这些事件分发给相应的 UI 元素。UI 元素可以通过实现特定的接口（如 <code>IPointerClickHandler</code>、<code>IPointerEnterHandler</code> 等）来监听和处理事件。<code>EventSystem</code> 会根据事件类型调用相应的接口方法。</p>
</li>
</ol>
<p>EventSystem 中主要的类图如下：</p>
<p><img src="https://s2.loli.net/2024/08/27/fY5XunWKbGVLv3S.png" alt="image.png"></p>
<p>下面会依次分析这些类的实现及他们之前的依赖关系。</p>
<h2 id="EventSystem">EventSystem</h2>
<p><code>EventSystem</code> 的部分代码如下，这里只保留了主要的逻辑部分，让我们来看一看 <code>EventSystem</code> 内部的实现。</p>
<details>
  <summary>点击展开代码</summary>
<pre><code><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Handles input, raycasting, and sending events.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The EventSystem is responsible for processing and handling events in a Unity scene. A scene should only contain one EventSystem. </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The EventSystem works in conjunction with a number of modules and mostly just holds state and delegates functionality to specific, overrideable components.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> When the EventSystem is started it searches for any BaseInputModules attached to the same GameObject and adds them to an internal list. </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> On update each attached module receives an UpdateModules call, where the module can modify internal state. </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> After each module has been Updated the active module has the Process call executed.This is where custom module processing can take place.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventSystem</span> : <span class="title">UIBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;BaseInputModule&gt; m_SystemInputModules = <span class="keyword">new</span> List&lt;BaseInputModule&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BaseInputModule m_CurrentInputModule;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> List&lt;EventSystem&gt; m_EventSystems = <span class="keyword">new</span> List&lt;EventSystem&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Return the current EventSystem.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EventSystem current</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_EventSystems.Count &gt; <span class="number">0</span> ? m_EventSystems[<span class="number">0</span>] : <span class="literal">null</span>; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> index = m_EventSystems.IndexOf(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (index &gt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_EventSystems.RemoveAt(index);</span><br><span class="line">                m_EventSystems.Insert(<span class="number">0</span>, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">EventSystem</span>()</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Recalculate the internal list of BaseInputModules.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateModules</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        GetComponents(m_SystemInputModules);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = m_SystemInputModules.Count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_SystemInputModules[i] &amp;&amp; m_SystemInputModules[i].IsActive())</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            m_SystemInputModules.RemoveAt(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Set the object as selected. Will send an OnDeselect the the old selected object and OnSelect to the new selected object.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selected&quot;&gt;</span>GameObject to select.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pointer&quot;&gt;</span>Associated EventData.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetSelectedGameObject</span>(<span class="params">GameObject selected, BaseEventData pointer</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_SelectionGuard)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">&quot;Attempting to select &quot;</span> + selected +  <span class="string">&quot;while already selecting an object.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_SelectionGuard = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (selected == m_CurrentSelected)</span><br><span class="line">        &#123;</span><br><span class="line">            m_SelectionGuard = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Debug.Log(&quot;Selection: new (&quot; + selected + &quot;) old (&quot; + m_CurrentSelected + &quot;)&quot;);</span></span><br><span class="line">        ExecuteEvents.Execute(m_CurrentSelected, pointer, ExecuteEvents.deselectHandler);</span><br><span class="line">        m_CurrentSelected = selected;</span><br><span class="line">        ExecuteEvents.Execute(m_CurrentSelected, pointer, ExecuteEvents.selectHandler);</span><br><span class="line">        m_SelectionGuard = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BaseEventData m_DummyData;</span><br><span class="line">    <span class="keyword">private</span> BaseEventData baseEventDataCache</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_DummyData == <span class="literal">null</span>)</span><br><span class="line">                m_DummyData = <span class="keyword">new</span> BaseEventData(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> m_DummyData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Set the object as selected. Will send an OnDeselect the the old selected object and OnSelect to the new selected object.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selected&quot;&gt;</span>GameObject to select.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetSelectedGameObject</span>(<span class="params">GameObject selected</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        SetSelectedGameObject(selected, baseEventDataCache);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">RaycastComparer</span>(<span class="params">RaycastResult lhs, RaycastResult rhs</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (lhs.module != rhs.module)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> lhsEventCamera = lhs.module.eventCamera;</span><br><span class="line">            <span class="keyword">var</span> rhsEventCamera = rhs.module.eventCamera;</span><br><span class="line">            <span class="keyword">if</span> (lhsEventCamera != <span class="literal">null</span> &amp;&amp; rhsEventCamera != <span class="literal">null</span> &amp;&amp; lhsEventCamera.depth != rhsEventCamera.depth)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// need to reverse the standard compareTo</span></span><br><span class="line">                <span class="keyword">if</span> (lhsEventCamera.depth &lt; rhsEventCamera.depth)</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (lhsEventCamera.depth == rhsEventCamera.depth)</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lhs.module.sortOrderPriority != rhs.module.sortOrderPriority)</span><br><span class="line">                <span class="keyword">return</span> rhs.module.sortOrderPriority.CompareTo(lhs.module.sortOrderPriority);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lhs.module.renderOrderPriority != rhs.module.renderOrderPriority)</span><br><span class="line">                <span class="keyword">return</span> rhs.module.renderOrderPriority.CompareTo(lhs.module.renderOrderPriority);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lhs.sortingLayer != rhs.sortingLayer)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Uses the layer value to properly compare the relative order of the layers.</span></span><br><span class="line">            <span class="keyword">var</span> rid = SortingLayer.GetLayerValueFromID(rhs.sortingLayer);</span><br><span class="line">            <span class="keyword">var</span> lid = SortingLayer.GetLayerValueFromID(lhs.sortingLayer);</span><br><span class="line">            <span class="keyword">return</span> rid.CompareTo(lid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lhs.sortingOrder != rhs.sortingOrder)</span><br><span class="line">            <span class="keyword">return</span> rhs.sortingOrder.CompareTo(lhs.sortingOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// comparing depth only makes sense if the two raycast results have the same root canvas (case 912396)</span></span><br><span class="line">        <span class="keyword">if</span> (lhs.depth != rhs.depth &amp;&amp; lhs.module.rootRaycaster == rhs.module.rootRaycaster)</span><br><span class="line">            <span class="keyword">return</span> rhs.depth.CompareTo(lhs.depth);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lhs.distance != rhs.distance)</span><br><span class="line">            <span class="keyword">return</span> lhs.distance.CompareTo(rhs.distance);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> lhs.index.CompareTo(rhs.index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Comparison&lt;RaycastResult&gt; s_RaycastComparer = RaycastComparer;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Raycast into the scene using all configured BaseRaycasters.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventData&quot;&gt;</span>Current pointer data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;raycastResults&quot;&gt;</span>List of &#x27;hits&#x27; to populate.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RaycastAll</span>(<span class="params">PointerEventData eventData, List&lt;RaycastResult&gt; raycastResults</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        raycastResults.Clear();</span><br><span class="line">        <span class="keyword">var</span> modules = RaycasterManager.GetRaycasters();</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; modules.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> module = modules[i];</span><br><span class="line">            <span class="keyword">if</span> (module == <span class="literal">null</span> || !module.IsActive())</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            module.Raycast(eventData, raycastResults);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        raycastResults.Sort(s_RaycastComparer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnEnable();</span><br><span class="line">        m_EventSystems.Add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_CurrentInputModule != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_CurrentInputModule.DeactivateModule();</span><br><span class="line">            m_CurrentInputModule = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_EventSystems.Remove(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">base</span>.OnDisable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TickModules</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; m_SystemInputModules.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_SystemInputModules[i] != <span class="literal">null</span>)</span><br><span class="line">                m_SystemInputModules[i].UpdateModule();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (current != <span class="keyword">this</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        TickModules();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">bool</span> changedModule = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; m_SystemInputModules.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> module = m_SystemInputModules[i];</span><br><span class="line">            <span class="keyword">if</span> (module.IsModuleSupported() &amp;&amp; module.ShouldActivateModule())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_CurrentInputModule != module)</span><br><span class="line">                &#123;</span><br><span class="line">                    ChangeEventModule(module);</span><br><span class="line">                    changedModule = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// no event module set... set the first valid one...</span></span><br><span class="line">        <span class="keyword">if</span> (m_CurrentInputModule == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; m_SystemInputModules.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> module = m_SystemInputModules[i];</span><br><span class="line">                <span class="keyword">if</span> (module.IsModuleSupported())</span><br><span class="line">                &#123;</span><br><span class="line">                    ChangeEventModule(module);</span><br><span class="line">                    changedModule = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!changedModule &amp;&amp; m_CurrentInputModule != <span class="literal">null</span>)</span><br><span class="line">            m_CurrentInputModule.Process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ChangeEventModule</span>(<span class="params">BaseInputModule module</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_CurrentInputModule == module)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_CurrentInputModule != <span class="literal">null</span>)</span><br><span class="line">            m_CurrentInputModule.DeactivateModule();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (module != <span class="literal">null</span>)</span><br><span class="line">            module.ActivateModule();</span><br><span class="line">        m_CurrentInputModule = module;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</details>
<p>首先，可以从注释中了解到该类的主要作用：</p>
<ul>
<li>
<p>类的功能：<code>EventSystem</code> 负责处理输入、射线检测（raycasting）和发送事件。</p>
</li>
<li>
<p>备注：<code>EventSystem</code> 负责在 Unity 场景中处理和管理事件。一个场景中应该只包含一个 <code>EventSystem</code>。<code>EventSystem</code> 与多个模块协同工作，主要是保存状态并将功能委托给特定的、可重写的组件。当 <code>EventSystem</code> 启动时，它会搜索附加到同一个 GameObject 的所有 <code>BaseInputModules</code>，并将它们添加到一个内部列表中。在每次更新时，每个附加的模块都会接收到一个 <code>UpdateModules</code> 调用，模块可以在此调用中修改内部状态。在每个模块更新之后，活动模块会执行 <code>Process</code> 调用，这是自定义模块处理的地方。</p>
</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Handles input, raycasting, and sending events.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The EventSystem is responsible for processing and handling events in a Unity scene. A scene should only contain one EventSystem. </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The EventSystem works in conjunction with a number of modules and mostly just holds state and delegates functionality to specific, overrideable components.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> When the EventSystem is started it searches for any BaseInputModules attached to the same GameObject and adds them to an internal list. </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> On update each attached module receives an UpdateModules call, where the module can modify internal state. </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> After each module has been Updated the active module has the Process call executed.This is where custom module processing can take place.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>首先，类中定义了三个变量，<code>m_SystemInputModules</code> 用于存储所有的输入模块，<code>m_CurrentInputModule</code> 代表当前处理的输入模块，<code>m_EventSystems</code> 用于存储所有的 <code>EventSystem</code> 实例。</p>
<p>需要注意的是 <code>m_EventSystems</code> 是一个静态变量，用于存储所有的 <code>EventSystem</code> 实例。<code>current</code> 属性用于获取当前的 <code>EventSystem</code> 实例，如果有多个 <code>EventSystem</code> 实例，只返回第一个实例。<code>current</code> 属性的 <code>set</code> 方法用于设置当前的 <code>EventSystem</code> 实例，如果已经存在该实例，则将其移动到列表的第一个位置。这个过程有点类似于 LRU 缓存算法，保证最近使用的 <code>EventSystem</code> 实例在列表的最前面。</p>
<p>此外，<code>EventSystem</code> 的构造函数是 <code>protected</code> 的，这意味着不能直接实例化 <code>EventSystem</code> 对象，只能通过继承 <code>EventSystem</code> 类来创建新的 <code>EventSystem</code> 实例。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;BaseInputModule&gt; m_SystemInputModules = <span class="keyword">new</span> List&lt;BaseInputModule&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> BaseInputModule m_CurrentInputModule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>  <span class="keyword">static</span> List&lt;EventSystem&gt; m_EventSystems = <span class="keyword">new</span> List&lt;EventSystem&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Return the current EventSystem.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> EventSystem current</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_EventSystems.Count &gt; <span class="number">0</span> ? m_EventSystems[<span class="number">0</span>] : <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="keyword">set</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> index = m_EventSystems.IndexOf(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (index &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_EventSystems.RemoveAt(index);</span><br><span class="line">            m_EventSystems.Insert(<span class="number">0</span>, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">EventSystem</span>()</span></span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><code>UpdateModules</code> 方法用于获取所有的输入模块至 <code>m_SystemInputModules</code>，并更新模块列表。<code>UpdateModules</code> 方法会遍历所有的输入模块，如果模块存在且处于激活状态，则保留，否则从列表中移除。</p>
<p>该函数并没有在 <code>EventSystem</code> 的生命周期中被调用，而是在 <code>InputModule</code> 的 <code>OnEnable()</code> 及 <code>OnDisable()</code> 方法中调用，用于更新输入模块列表。后面会详细介绍 <code>InputModule</code> 的实现。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Recalculate the internal list of BaseInputModules.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateModules</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    GetComponents(m_SystemInputModules);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = m_SystemInputModules.Count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_SystemInputModules[i] &amp;&amp; m_SystemInputModules[i].IsActive())</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        m_SystemInputModules.RemoveAt(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是 <code>SetSelectedGameObject</code> 方法，用于设置选中的游戏对象。该方法会发送 <code>OnDeselect</code> 事件给旧的选中对象，发送 <code>OnSelect</code> 事件给新的选中对象。<code>SetSelectedGameObject</code> 方法有两个重载，前者接受一个额外的 <code>BaseEventData</code> 参数，用于传递事件数据；后者只接受一个 <code>GameObject</code> 参数，会使用 <code>baseEventDataCache</code> 方法传递一个默认的 <code>BaseEventData</code> 对象。</p>
<p>为了不重复创建 <code>BaseEventData</code> 对象，<code>EventSystem</code> 类中定义了一个 <code>m_DummyData</code> 变量，用于缓存 <code>BaseEventData</code> 对象。<code>baseEventDataCache</code> 方法用于获取 <code>m_DummyData</code> 对象，如果对象为空，则创建一个新的 <code>BaseEventData</code> 对象。这种做法可以减少内存分配的开销。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Set the object as selected. Will send an OnDeselect the the old selected object and OnSelect to the new selected object.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selected&quot;&gt;</span>GameObject to select.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pointer&quot;&gt;</span>Associated EventData.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetSelectedGameObject</span>(<span class="params">GameObject selected, BaseEventData pointer</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_SelectionGuard)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogError(<span class="string">&quot;Attempting to select &quot;</span> + selected +  <span class="string">&quot;while already selecting an object.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_SelectionGuard = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (selected == m_CurrentSelected)</span><br><span class="line">    &#123;</span><br><span class="line">        m_SelectionGuard = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Debug.Log(&quot;Selection: new (&quot; + selected + &quot;) old (&quot; + m_CurrentSelected + &quot;)&quot;);</span></span><br><span class="line">    ExecuteEvents.Execute(m_CurrentSelected, pointer, ExecuteEvents.deselectHandler);</span><br><span class="line">    m_CurrentSelected = selected;</span><br><span class="line">    ExecuteEvents.Execute(m_CurrentSelected, pointer, ExecuteEvents.selectHandler);</span><br><span class="line">    m_SelectionGuard = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> BaseEventData m_DummyData;</span><br><span class="line"><span class="keyword">private</span> BaseEventData baseEventDataCache</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_DummyData == <span class="literal">null</span>)</span><br><span class="line">            m_DummyData = <span class="keyword">new</span> BaseEventData(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> m_DummyData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Set the object as selected. Will send an OnDeselect the the old selected object and OnSelect to the new selected object.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;selected&quot;&gt;</span>GameObject to select.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetSelectedGameObject</span>(<span class="params">GameObject selected</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    SetSelectedGameObject(selected, baseEventDataCache);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是 <code>RaycastAll</code> 方法，用于对场景中的所有 <code>BaseRaycaster</code> 进行射线检测。<code>RaycastAll</code> 方法会清空 <code>raycastResults</code> 列表，然后遍历所有的 <code>BaseRaycaster</code>，调用 <code>Raycaster.Raycast</code> 方法进行射线检测，并将结果保存到 <code>raycastResults</code> 列表中。最后，对 <code>raycastResults</code> 列表进行排序，排序规则由 <code>RaycastComparer</code> 方法定义。</p>
<p>关于 <code>RaycastAll</code> 有以下几个需要注意的地方：</p>
<ol>
<li>
<p><code>EventSystem</code> 并不直接调用 <code>RaycastAll</code> 方法，而是由 <code>InputModule</code> 调用。<code>InputModule</code> 会在 <code>Process</code> 方法中调用 <code>RaycastAll</code> 方法，获取射线检测的结果。</p>
</li>
<li>
<p><code>RaycastComparer</code> 方法用于对射线检测结果进行排序，总体而言就是将更接近摄像机的结果排在前面。</p>
</li>
<li>
<p><code>RaycastAll</code> 方法会通过 <code>RaycasterManager.GetRaycasters()</code> 获取所有的 <code>BaseRaycaster</code>，然后遍历调用 <code>Raycaster.Raycast</code> 方法进行射线检测。</p>
</li>
</ol>
<p>关于 <code>InputModule</code> 及 <code>RaycasterManager</code> 的实现会在下文中详细介绍。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">RaycastComparer</span>(<span class="params">RaycastResult lhs, RaycastResult rhs</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (lhs.module != rhs.module)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> lhsEventCamera = lhs.module.eventCamera;</span><br><span class="line">        <span class="keyword">var</span> rhsEventCamera = rhs.module.eventCamera;</span><br><span class="line">        <span class="keyword">if</span> (lhsEventCamera != <span class="literal">null</span> &amp;&amp; rhsEventCamera != <span class="literal">null</span> &amp;&amp; lhsEventCamera.depth != rhsEventCamera.depth)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// need to reverse the standard compareTo</span></span><br><span class="line">            <span class="keyword">if</span> (lhsEventCamera.depth &lt; rhsEventCamera.depth)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (lhsEventCamera.depth == rhsEventCamera.depth)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lhs.module.sortOrderPriority != rhs.module.sortOrderPriority)</span><br><span class="line">            <span class="keyword">return</span> rhs.module.sortOrderPriority.CompareTo(lhs.module.sortOrderPriority);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lhs.module.renderOrderPriority != rhs.module.renderOrderPriority)</span><br><span class="line">            <span class="keyword">return</span> rhs.module.renderOrderPriority.CompareTo(lhs.module.renderOrderPriority);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lhs.sortingLayer != rhs.sortingLayer)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Uses the layer value to properly compare the relative order of the layers.</span></span><br><span class="line">        <span class="keyword">var</span> rid = SortingLayer.GetLayerValueFromID(rhs.sortingLayer);</span><br><span class="line">        <span class="keyword">var</span> lid = SortingLayer.GetLayerValueFromID(lhs.sortingLayer);</span><br><span class="line">        <span class="keyword">return</span> rid.CompareTo(lid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lhs.sortingOrder != rhs.sortingOrder)</span><br><span class="line">        <span class="keyword">return</span> rhs.sortingOrder.CompareTo(lhs.sortingOrder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// comparing depth only makes sense if the two raycast results have the same root canvas (case 912396)</span></span><br><span class="line">    <span class="keyword">if</span> (lhs.depth != rhs.depth &amp;&amp; lhs.module.rootRaycaster == rhs.module.rootRaycaster)</span><br><span class="line">        <span class="keyword">return</span> rhs.depth.CompareTo(lhs.depth);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lhs.distance != rhs.distance)</span><br><span class="line">        <span class="keyword">return</span> lhs.distance.CompareTo(rhs.distance);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lhs.index.CompareTo(rhs.index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Comparison&lt;RaycastResult&gt; s_RaycastComparer = RaycastComparer;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Raycast into the scene using all configured BaseRaycasters.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventData&quot;&gt;</span>Current pointer data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;raycastResults&quot;&gt;</span>List of &#x27;hits&#x27; to populate.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RaycastAll</span>(<span class="params">PointerEventData eventData, List&lt;RaycastResult&gt; raycastResults</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    raycastResults.Clear();</span><br><span class="line">    <span class="keyword">var</span> modules = RaycasterManager.GetRaycasters();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; modules.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> module = modules[i];</span><br><span class="line">        <span class="keyword">if</span> (module == <span class="literal">null</span> || !module.IsActive())</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        module.Raycast(eventData, raycastResults);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    raycastResults.Sort(s_RaycastComparer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是关于 <code>EventSystem</code> 的生命周期的两个方法，<code>OnEnable</code> 和 <code>OnDisable</code>。<code>OnEnable</code> 方法会在 <code>EventSystem</code> 启用时调用，用于将当前 <code>EventSystem</code> 实例添加到 <code>m_EventSystems</code> 列表中。<code>OnDisable</code> 方法会在 <code>EventSystem</code> 禁用时调用，用于将当前的输入模块禁用，并从 <code>m_EventSystems</code> 列表中移除当前 <code>EventSystem</code> 实例。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnEnable();</span><br><span class="line">    m_EventSystems.Add(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_CurrentInputModule != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_CurrentInputModule.DeactivateModule();</span><br><span class="line">        m_CurrentInputModule = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_EventSystems.Remove(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">base</span>.OnDisable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后便是 <code>EventSystem</code> 中最重要的方法 <code>Update</code>，该方法会在每一帧被调用。<code>Update</code> 方法首先会调用 <code>TickModules</code> 方法，遍历所有的输入模块并调用其中的 <code>UpdateModule</code> 方法。</p>
<p>然后会遍历所有的输入模块，并设置当前的输入模块，最后调用当前输入模块的 <code>Process</code> 方法，完成事件的处理。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TickModules</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; m_SystemInputModules.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_SystemInputModules[i] != <span class="literal">null</span>)</span><br><span class="line">            m_SystemInputModules[i].UpdateModule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (current != <span class="keyword">this</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    TickModules();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> changedModule = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; m_SystemInputModules.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> module = m_SystemInputModules[i];</span><br><span class="line">        <span class="keyword">if</span> (module.IsModuleSupported() &amp;&amp; module.ShouldActivateModule())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_CurrentInputModule != module)</span><br><span class="line">            &#123;</span><br><span class="line">                ChangeEventModule(module);</span><br><span class="line">                changedModule = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// no event module set... set the first valid one...</span></span><br><span class="line">    <span class="keyword">if</span> (m_CurrentInputModule == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; m_SystemInputModules.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> module = m_SystemInputModules[i];</span><br><span class="line">            <span class="keyword">if</span> (module.IsModuleSupported())</span><br><span class="line">            &#123;</span><br><span class="line">                ChangeEventModule(module);</span><br><span class="line">                changedModule = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!changedModule &amp;&amp; m_CurrentInputModule != <span class="literal">null</span>)</span><br><span class="line">        m_CurrentInputModule.Process();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ChangeEventModule</span>(<span class="params">BaseInputModule module</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_CurrentInputModule == module)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_CurrentInputModule != <span class="literal">null</span>)</span><br><span class="line">        m_CurrentInputModule.DeactivateModule();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (module != <span class="literal">null</span>)</span><br><span class="line">        module.ActivateModule();</span><br><span class="line">    m_CurrentInputModule = module;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小结">小结</h3>
<p>以上我们对 <code>EventSystem</code> 类的实现进行了详细介绍。总的来看，<code>EventSystem</code> 的主要功能是处理输入、射线检测和发送事件。<br>
首先，挂载了 <code>EventSystem</code> 的 GameObject 会在启动时收集所有的输入模块并添加到 <code>m_SystemInputModules</code> 列表中。然后，<code>EventSystem</code> 会在每一帧调用 <code>Update</code> 方法，遍历所有的输入模块并调用 <code>Process</code> 方法，完成事件的处理。</p>
<p>此外，<code>EventSystem</code> 还提供了一些方法用于设置选中的游戏对象、射线检测等功能。这些方法会在 <code>InputModule</code> 及 <code>Raycaster</code> 中调用。</p>
<p><img src="https://s2.loli.net/2024/08/28/I9glAajGvqcpNnt.png" alt="image.png"></p>
<h2 id="InputModule">InputModule</h2>
<h3 id="BaseInput">BaseInput</h3>
<p>在介绍 <code>BaseInputModule</code> 之前需要先了解一下 <code>BaseInput</code>，该类是 <code>BaseInputModule</code> 中处理输入的接口类，封装了许多诸如鼠标位置、滚动、存在状态等的接口，并将这些属性都标记为 <code>virtual</code>，这意味着我们可以派生出自己的 <code>Input</code> 类并重写这些属性，以达到自定义输入的效果。</p>
<p>值得注意的是，<code>BaseInput</code> 本身也只是对 <code>Input</code> 模块的一层封装而已，其中的所有属性都来自于 <code>Input</code> 类中的 <code>static</code> 变量。可以理解为 <code>BaseInput</code> 只是为了 UI 界面的使用方便，将 Unity 自身的 <code>Input</code> 模块中的部分属性拆分出来做了二次封装，本身并不直接参与用户输入的监听及处理。</p>
<details>
    <summary>点击展开代码</summary>
<pre><code><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Interface to the Input system used by the BaseInputModule. With this it is possible to bypass the Input system with your own but still use the same InputModule. </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> For example this can be used to feed fake input into the UI or interface with a different input system.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseInput</span> : <span class="title">UIBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.compositionString. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">string</span> compositionString</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Input.compositionString; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.imeCompositionMode. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> IMECompositionMode imeCompositionMode</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Input.imeCompositionMode; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; Input.imeCompositionMode = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.compositionCursorPos. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Vector2 compositionCursorPos</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Input.compositionCursorPos; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; Input.compositionCursorPos = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.mousePresent. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> mousePresent</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Input.mousePresent; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.GetMouseButtonDown. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;button&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">GetMouseButtonDown</span>(<span class="params"><span class="built_in">int</span> button</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Input.GetMouseButtonDown(button);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.GetMouseButtonUp. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">GetMouseButtonUp</span>(<span class="params"><span class="built_in">int</span> button</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Input.GetMouseButtonUp(button);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.GetMouseButton. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">GetMouseButton</span>(<span class="params"><span class="built_in">int</span> button</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Input.GetMouseButton(button);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.mousePosition. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Vector2 mousePosition</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Input.mousePosition; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.mouseScrollDelta. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Vector2 mouseScrollDelta</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Input.mouseScrollDelta; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.touchSupported. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> touchSupported</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Input.touchSupported; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.touchCount. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">int</span> touchCount</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Input.touchCount; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.GetTouch. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;index&quot;&gt;</span>Touch index to get<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> Touch <span class="title">GetTouch</span>(<span class="params"><span class="built_in">int</span> index</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Input.GetTouch(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.GetAxisRaw. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;axisName&quot;&gt;</span>Axis name to check<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">float</span> <span class="title">GetAxisRaw</span>(<span class="params"><span class="built_in">string</span> axisName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Input.GetAxisRaw(axisName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface to Input.GetButtonDown. Can be overridden to provide custom input instead of using the Input class.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buttonName&quot;&gt;</span>Button name to get<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">GetButtonDown</span>(<span class="params"><span class="built_in">string</span> buttonName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Input.GetButtonDown(buttonName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</details>
<p>这部分代码较多，这里就不一一展开了，我们只需要知道 <code>BaseInput</code> 向 <code>InputModule</code> 提供了一系列的接口，用于获取鼠标位置、滚动、触摸等输入信息。这些接口都是 <code>virtual</code> 的，可以被子类重写，用于自定义输入的处理。而 <code>BaseInput</code> 本身并不直接参与用户输入的监听及处理，只是对 <code>Input</code> 模块的一层封装。</p>
<h3 id="EventData">EventData</h3>
<p><code>EventData</code> 是 <code>InputModule</code> 中使用到的另一个数据类，负责传递 <code>EventSystem</code> 中产生的各种事件数据。<code>EventData</code> 类中定义了一系列的属性和方法，用于存储事件数据，如 <code>currentInputModule</code>、<code>selectedObject</code> 等，<code>BaseEventData</code> 是 <code>EventData</code> 的基类，派生出了一系列的子类，如 <code>PointerEventData</code>、<code>AxisEventData</code> 等，用于存储不同类型的事件数据。</p>
<p><img src="https://s2.loli.net/2024/08/28/PYGfQnOSowlA1It.png" alt="image.png"></p>
<ul>
<li>
<p><code>BaseEventData</code>：基础的事件信息</p>
</li>
<li>
<p><code>PointerEventData</code>: 存储 触摸/点击/鼠标操作 事件信息</p>
</li>
<li>
<p><code>AxisEventData</code>：移动相关的事件信息，注：拖动的操作属于 <code>PointerEventData</code></p>
</li>
</ul>
<p>这里我们只分析一下 <code>BaseEventData</code> 的实现：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> A class that can be used for sending simple events via the event system.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AbstractEventData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">bool</span> m_Used;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Reset the event.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Reset</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        m_Used = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Use the event.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Internally sets a flag that can be checked via used to see if further processing should happen.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Use</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        m_Used = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Is the event used?</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> used</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_Used; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> A class that contains the base event data that is common to all event types in the new EventSystem.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseEventData</span> : <span class="title">AbstractEventData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> EventSystem m_EventSystem;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseEventData</span>(<span class="params">EventSystem eventSystem</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        m_EventSystem = eventSystem;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> &gt;A reference to the BaseInputModule that sent this event.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseInputModule currentInputModule</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_EventSystem.currentInputModule; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The object currently considered selected by the EventSystem.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> GameObject selectedObject</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_EventSystem.currentSelectedGameObject; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; m_EventSystem.SetSelectedGameObject(<span class="keyword">value</span>, <span class="keyword">this</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，定义了一个抽象类 <code>AbstractEventData</code>，其中包含了 <code>Reset</code>、<code>Use</code>、<code>used</code> 三个方法，用于重置事件、标记事件已使用、判断事件是否已使用。<code>BaseEventData</code> 继承自 <code>AbstractEventData</code>，并额外定义了 <code>m_EventSystem</code>、<code>currentInputModule</code>、<code>selectedObject</code> 三个属性，用于存储事件系统、当前输入模块、当前选中的游戏对象。</p>
<p>其中，<code>used</code> 属性对于事件的处理非常重要，当事件被处理后，会调用 <code>Use</code> 方法将 <code>m_Used</code> 标记为 <code>true</code>，表示事件已被使用，不再需要进一步处理。在下文的分析中，我们会看到 <code>InputModule</code> 中会根据事件的 <code>used</code> 属性来判断是否需要继续处理事件。</p>
<h3 id="BaseInputModule">BaseInputModule</h3>
<p><code>BaseInputModule</code> 是所有输入模块的基类，它定义了一系列的虚方法，用于处理用户输入事件。</p>
<details>
    <summary>点击展开代码</summary>
<pre><code><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line">    [<span class="meta">RequireComponent(typeof(EventSystem))</span>]</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> A base module that raises events and sends them to GameObjects.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> An Input Module is a component of the EventSystem that is responsible for raising events and sending them to GameObjects for handling. </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The BaseInputModule is a class that all Input Modules in the EventSystem inherit from. Examples of provided modules are TouchInputModule and StandaloneInputModule, </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> if these are inadequate for your project you can create your own by extending from the BaseInputModule.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseInputModule</span> : <span class="title">UIBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">NonSerialized</span>]</span><br><span class="line">    <span class="keyword">protected</span> List&lt;RaycastResult&gt; m_RaycastResultCache = <span class="keyword">new</span> List&lt;RaycastResult&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AxisEventData m_AxisEventData;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EventSystem m_EventSystem;</span><br><span class="line">    <span class="keyword">private</span> BaseEventData m_BaseEventData;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> BaseInput m_InputOverride;</span><br><span class="line">    <span class="keyword">private</span> BaseInput m_DefaultInput;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The current BaseInput being used by the input module.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseInput input</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_InputOverride != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> m_InputOverride;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m_DefaultInput == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> inputs = GetComponents&lt;BaseInput&gt;();</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> baseInput <span class="keyword">in</span> inputs)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// We dont want to use any classes that derrive from BaseInput for default.</span></span><br><span class="line">                    <span class="keyword">if</span> (baseInput != <span class="literal">null</span> &amp;&amp; baseInput.GetType() == <span class="keyword">typeof</span>(BaseInput))</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_DefaultInput = baseInput;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (m_DefaultInput == <span class="literal">null</span>)</span><br><span class="line">                    m_DefaultInput = gameObject.AddComponent&lt;BaseInput&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> m_DefaultInput;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Used to override the default BaseInput for the input module.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> With this it is possible to bypass the Input system with your own but still use the same InputModule. For example this can be used to feed fake input into the UI or interface with a different input system.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseInput inputOverride</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_InputOverride; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; m_InputOverride = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> EventSystem eventSystem</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_EventSystem; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnEnable();</span><br><span class="line">        m_EventSystem = GetComponent&lt;EventSystem&gt;();</span><br><span class="line">        m_EventSystem.UpdateModules();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        m_EventSystem.UpdateModules();</span><br><span class="line">        <span class="keyword">base</span>.OnDisable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Process the current tick for the module.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Process</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Return the first valid RaycastResult.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> RaycastResult <span class="title">FindFirstRaycast</span>(<span class="params">List&lt;RaycastResult&gt; candidates</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; candidates.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (candidates[i].gameObject == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> candidates[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RaycastResult();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Given an input movement, determine the best MoveDirection.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;x&quot;&gt;</span>X movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;y&quot;&gt;</span>Y movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> MoveDirection <span class="title">DetermineMoveDirection</span>(<span class="params"><span class="built_in">float</span> x, <span class="built_in">float</span> y</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DetermineMoveDirection(x, y, <span class="number">0.6f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Given an input movement, determine the best MoveDirection.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;x&quot;&gt;</span>X movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;y&quot;&gt;</span>Y movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deadZone&quot;&gt;</span>Dead zone.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> MoveDirection <span class="title">DetermineMoveDirection</span>(<span class="params"><span class="built_in">float</span> x, <span class="built_in">float</span> y, <span class="built_in">float</span> deadZone</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// if vector is too small... just return</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> Vector2(x, y).sqrMagnitude &lt; deadZone * deadZone)</span><br><span class="line">            <span class="keyword">return</span> MoveDirection.None;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Mathf.Abs(x) &gt; Mathf.Abs(y))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (x &gt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> MoveDirection.Right;</span><br><span class="line">            <span class="keyword">return</span> MoveDirection.Left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (y &gt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> MoveDirection.Up;</span><br><span class="line">            <span class="keyword">return</span> MoveDirection.Down;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Given 2 GameObjects, return a common root GameObject (or null).</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;g1&quot;&gt;</span>GameObject to compare<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;g2&quot;&gt;</span>GameObject to compare<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> GameObject <span class="title">FindCommonRoot</span>(<span class="params">GameObject g1, GameObject g2</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (g1 == <span class="literal">null</span> || g2 == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> t1 = g1.transform;</span><br><span class="line">        <span class="keyword">while</span> (t1 != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> t2 = g2.transform;</span><br><span class="line">            <span class="keyword">while</span> (t2 != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (t1 == t2)</span><br><span class="line">                    <span class="keyword">return</span> t1.gameObject;</span><br><span class="line">                t2 = t2.parent;</span><br><span class="line">            &#125;</span><br><span class="line">            t1 = t1.parent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// walk up the tree till a common root between the last entered and the current entered is foung</span></span><br><span class="line">    <span class="comment">// send exit events up to (but not inluding) the common root. Then send enter events up to</span></span><br><span class="line">    <span class="comment">// (but not including the common root).</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">HandlePointerExitAndEnter</span>(<span class="params">PointerEventData currentPointerData, GameObject newEnterTarget</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// if we have no target / pointerEnter has been deleted</span></span><br><span class="line">        <span class="comment">// just send exit events to anything we are tracking</span></span><br><span class="line">        <span class="comment">// then exit</span></span><br><span class="line">        <span class="keyword">if</span> (newEnterTarget == <span class="literal">null</span> || currentPointerData.pointerEnter == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; currentPointerData.hovered.Count; ++i)</span><br><span class="line">                ExecuteEvents.Execute(currentPointerData.hovered[i], currentPointerData, ExecuteEvents.pointerExitHandler);</span><br><span class="line"></span><br><span class="line">            currentPointerData.hovered.Clear();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newEnterTarget == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                currentPointerData.pointerEnter = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if we have not changed hover target</span></span><br><span class="line">        <span class="keyword">if</span> (currentPointerData.pointerEnter == newEnterTarget &amp;&amp; newEnterTarget)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        GameObject commonRoot = FindCommonRoot(currentPointerData.pointerEnter, newEnterTarget);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// and we already an entered object from last time</span></span><br><span class="line">        <span class="keyword">if</span> (currentPointerData.pointerEnter != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// send exit handler call to all elements in the chain</span></span><br><span class="line">            <span class="comment">// until we reach the new target, or null!</span></span><br><span class="line">            Transform t = currentPointerData.pointerEnter.transform;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (t != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// if we reach the common root break out!</span></span><br><span class="line">                <span class="keyword">if</span> (commonRoot != <span class="literal">null</span> &amp;&amp; commonRoot.transform == t)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                ExecuteEvents.Execute(t.gameObject, currentPointerData, ExecuteEvents.pointerExitHandler);</span><br><span class="line">                currentPointerData.hovered.Remove(t.gameObject);</span><br><span class="line">                t = t.parent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// now issue the enter call up to but not including the common root</span></span><br><span class="line">        currentPointerData.pointerEnter = newEnterTarget;</span><br><span class="line">        <span class="keyword">if</span> (newEnterTarget != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Transform t = newEnterTarget.transform;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (t != <span class="literal">null</span> &amp;&amp; t.gameObject != commonRoot)</span><br><span class="line">            &#123;</span><br><span class="line">                ExecuteEvents.Execute(t.gameObject, currentPointerData, ExecuteEvents.pointerEnterHandler);</span><br><span class="line">                currentPointerData.hovered.Add(t.gameObject);</span><br><span class="line">                t = t.parent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Given some input data generate an AxisEventData that can be used by the event system.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;x&quot;&gt;</span>X movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;y&quot;&gt;</span>Y movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deadZone&quot;&gt;</span>Dead zone.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> AxisEventData <span class="title">GetAxisEventData</span>(<span class="params"><span class="built_in">float</span> x, <span class="built_in">float</span> y, <span class="built_in">float</span> moveDeadZone</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_AxisEventData == <span class="literal">null</span>)</span><br><span class="line">            m_AxisEventData = <span class="keyword">new</span> AxisEventData(eventSystem);</span><br><span class="line"></span><br><span class="line">        m_AxisEventData.Reset();</span><br><span class="line">        m_AxisEventData.moveVector = <span class="keyword">new</span> Vector2(x, y);</span><br><span class="line">        m_AxisEventData.moveDir = DetermineMoveDirection(x, y, moveDeadZone);</span><br><span class="line">        <span class="keyword">return</span> m_AxisEventData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Generate a BaseEventData that can be used by the EventSystem.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> BaseEventData <span class="title">GetBaseEventData</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_BaseEventData == <span class="literal">null</span>)</span><br><span class="line">            m_BaseEventData = <span class="keyword">new</span> BaseEventData(eventSystem);</span><br><span class="line"></span><br><span class="line">        m_BaseEventData.Reset();</span><br><span class="line">        <span class="keyword">return</span> m_BaseEventData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> If the module is pointer based, then override this to return true if the pointer is over an event system object.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pointerId&quot;&gt;</span>Pointer ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Is the given pointer over an event system object?<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">IsPointerOverGameObject</span>(<span class="params"><span class="built_in">int</span> pointerId</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Should the module be activated.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">ShouldActivateModule</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> enabled &amp;&amp; gameObject.activeInHierarchy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Called when the module is deactivated. Override this if you want custom code to execute when you deactivate your module.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DeactivateModule</span>()</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Called when the module is activated. Override this if you want custom code to execute when you activate your module.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ActivateModule</span>()</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Update the internal state of the Module.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateModule</span>()</span></span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Check to see if the module is supported. Override this if you have a platform specific module (eg. TouchInputModule that you do not want to activate on standalone.)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Is the module supported.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">IsModuleSupported</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</details>
<p>首先，<code>BaseInputModule</code> 被添加了 <code>RequireComponent</code> 特性，表示 <code>BaseInputModule</code> 必须要附加到一个 <code>EventSystem</code> 上。</p>
<p>通过阅读注释，我们可以了解到 <code>BaseInputModule</code> 是一个基础模块，用于触发事件并将事件发送到游戏对象进行处理。该类是所有输入模块的基类。所有输入模块都继承自这个类。Unity 提供了一些示例模块，如 <code>TouchInputModule</code> 和 <code>StandaloneInputModule</code>。如果这些示例模块不能满足项目需求，可以通过继承 <code>BaseInputModule</code> 创建自定义的输入模块。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">RequireComponent(typeof(EventSystem))</span>]</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> A base module that raises events and sends them to GameObjects.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> An Input Module is a component of the EventSystem that is responsible for raising events and sending them to GameObjects for handling. </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The BaseInputModule is a class that all Input Modules in the EventSystem inherit from. Examples of provided modules are TouchInputModule and StandaloneInputModule, </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> if these are inadequate for your project you can create your own by extending from the BaseInputModule.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>接下来是 <code>BaseInputModule</code> 中的定义的一些属性。其中，<code>m_RaycastResultCache</code>、<code>m_AxisEventData</code>、<code>m_BaseEventData</code> 分别用于缓存射线检测结果、轴事件数据、基础事件数据。这些属性都是后续的函数中会频繁使用的一些中间变量，这里也是通过缓存的方式来减少内存分配的开销。</p>
<p>其中，<code>input</code> 属性比较有意思，它用于获取当前的 <code>BaseInput</code> 对象。如果 <code>m_InputOverride</code> 不为空，则返回 <code>m_InputOverride</code>；否则，遍历当前 GameObject 上的所有 <code>BaseInput</code> 组件，找到第一个类型为 <code>BaseInput</code> 的组件并返回。如果没有找到，则创建一个新的 <code>BaseInput</code> 组件并返回。</p>
<p>可以看出，<code>m_InputOverride</code> 是可以覆盖默认的 <code>BaseInput</code> 的，这样就可以通过自定义的 <code>BaseInput</code> 来实现自定义的输入处理。同时类中开放了 <code>inputOverride</code> 属性，用于设置 <code>m_InputOverride</code>。</p>
<p>此外，通过 <code>eventSystem</code> 属性可以获取当前的 <code>EventSystem</code> 实例。由此可以看出，<code>InputModule</code> 与 <code>EventSystem</code> 是双向关联的。一方面，<code>EventSystem</code> 会在启用时调用 <code>UpdateModules</code> 方法，更新输入模块列表；另一方面，<code>InputModule</code> 会在启用时获取当前的 <code>EventSystem</code> 实例。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">NonSerialized</span>]</span><br><span class="line"><span class="keyword">protected</span> List&lt;RaycastResult&gt; m_RaycastResultCache = <span class="keyword">new</span> List&lt;RaycastResult&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> AxisEventData m_AxisEventData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> EventSystem m_EventSystem;</span><br><span class="line"><span class="keyword">private</span> BaseEventData m_BaseEventData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> BaseInput m_InputOverride;</span><br><span class="line"><span class="keyword">private</span> BaseInput m_DefaultInput;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> The current BaseInput being used by the input module.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> BaseInput input</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_InputOverride != <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> m_InputOverride;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_DefaultInput == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> inputs = GetComponents&lt;BaseInput&gt;();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> baseInput <span class="keyword">in</span> inputs)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// We dont want to use any classes that derrive from BaseInput for default.</span></span><br><span class="line">                <span class="keyword">if</span> (baseInput != <span class="literal">null</span> &amp;&amp; baseInput.GetType() == <span class="keyword">typeof</span>(BaseInput))</span><br><span class="line">                &#123;</span><br><span class="line">                    m_DefaultInput = baseInput;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m_DefaultInput == <span class="literal">null</span>)</span><br><span class="line">                m_DefaultInput = gameObject.AddComponent&lt;BaseInput&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> m_DefaultInput;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Used to override the default BaseInput for the input module.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> With this it is possible to bypass the Input system with your own but still use the same InputModule. For example this can be used to feed fake input into the UI or interface with a different input system.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> BaseInput inputOverride</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_InputOverride; &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123; m_InputOverride = <span class="keyword">value</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> EventSystem eventSystem</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_EventSystem; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是一些虚函数，挑几个重要的分析一下。</p>
<ul>
<li>
<p><code>OnEnable</code> 与 <code>OnDisable</code> 方法用于在 <code>InputModule</code> 启用和禁用时调用，用于更新输入模块列表。<code>OnEnable</code> 方法会获取当前的 <code>EventSystem</code> 实例，并调用 <code>UpdateModules</code> 方法更新输入模块列表；<code>OnDisable</code> 方法会调用 <code>UpdateModules</code> 方法，将当前的输入模块禁用，并从输入模块列表中移除。</p>
</li>
<li>
<p><code>Process</code> 方法是 <code>BaseInputModule</code> 的核心方法，用于处理当前的输入事件。这里 <code>Process</code> 被标记为了 <code>abstract</code>，表示子类必须实现该方法。<code>Process</code> 方法会在每一帧被调用，用于处理当前的输入事件。</p>
</li>
<li>
<p><code>ActivateModule</code>、<code>DeactivateModule</code>、<code>UpdateModule</code> 方法分别用于激活、禁用、更新输入模块。这些方法都是虚方法，可以被子类重写。</p>
</li>
<li>
<p><code>GetAxisEventData</code>、<code>GetBaseEventData</code> 方法用于生成轴事件数据和基础事件数据。</p>
</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnEnable();</span><br><span class="line">    m_EventSystem = GetComponent&lt;EventSystem&gt;();</span><br><span class="line">    m_EventSystem.UpdateModules();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    m_EventSystem.UpdateModules();</span><br><span class="line">    <span class="keyword">base</span>.OnDisable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Process the current tick for the module.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Process</span>()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Should the module be activated.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">bool</span> <span class="title">ShouldActivateModule</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> enabled &amp;&amp; gameObject.activeInHierarchy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Called when the module is deactivated. Override this if you want custom code to execute when you deactivate your module.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DeactivateModule</span>()</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Called when the module is activated. Override this if you want custom code to execute when you activate your module.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ActivateModule</span>()</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Update the internal state of the Module.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">UpdateModule</span>()</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Given some input data generate an AxisEventData that can be used by the event system.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;x&quot;&gt;</span>X movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;y&quot;&gt;</span>Y movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deadZone&quot;&gt;</span>Dead zone.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> AxisEventData <span class="title">GetAxisEventData</span>(<span class="params"><span class="built_in">float</span> x, <span class="built_in">float</span> y, <span class="built_in">float</span> moveDeadZone</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_AxisEventData == <span class="literal">null</span>)</span><br><span class="line">        m_AxisEventData = <span class="keyword">new</span> AxisEventData(eventSystem);</span><br><span class="line"></span><br><span class="line">    m_AxisEventData.Reset();</span><br><span class="line">    m_AxisEventData.moveVector = <span class="keyword">new</span> Vector2(x, y);</span><br><span class="line">    m_AxisEventData.moveDir = DetermineMoveDirection(x, y, moveDeadZone);</span><br><span class="line">    <span class="keyword">return</span> m_AxisEventData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Generate a BaseEventData that can be used by the EventSystem.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> BaseEventData <span class="title">GetBaseEventData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_BaseEventData == <span class="literal">null</span>)</span><br><span class="line">        m_BaseEventData = <span class="keyword">new</span> BaseEventData(eventSystem);</span><br><span class="line"></span><br><span class="line">    m_BaseEventData.Reset();</span><br><span class="line">    <span class="keyword">return</span> m_BaseEventData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是一些工具性的方法，这些方法用于处理输入事件，如射线检测、移动方向的判断等。这些方法大都被标记为 <code>static</code>，表示这些方法是独立于对象的，可以直接通过类名调用。</p>
<ul>
<li>
<p><code>FindFirstRaycast</code> 方法用于返回第一个有效的射线检测结果。一般而言就是确定用户当前点击的是哪个 UI 元素了。</p>
</li>
<li>
<p><code>DetermineMoveDirection</code> 方法用于根据输入的移动方向，判断最佳的移动方向。这个方法会根据输入的 x、y 值，判断出最佳的移动方向。</p>
</li>
<li>
<p><code>FindCommonRoot</code> 方法用于找到两个 <code>GameObject</code> 的共同根节点。这个方法会遍历两个 <code>GameObject</code> 的父节点，直到找到共同的根节点。</p>
<p>值得一提的是，该算法使用的场景有点像 LCA（最近公共祖先）的算法，只不过这里是找到两个 <code>GameObject</code> 的共同根节点。这个算法的时间复杂度是 O(n^2)，如果使用 LCA 算法，时间复杂度可以降低到 O(n)。但两个 <code>GameObject</code> 不一定在同一棵树上，因此这种暴力的方法也是可以接受的。</p>
</li>
<li>
<p><code>HandlePointerExitAndEnter</code> 方法用于处理指针的进入和退出事件。这个方法会根据当前的指针数据和新的进入目标，发送相应的进入和退出事件。该方法会调用 <code>FindCommonRoot</code> 方法找到两个 GameObject 的共同根节点，然后分别沿着父节点向上发送退出和进入事件。可以看到，事件的处理都是调用 <code>ExecuteEvents.Execute</code> 方法来完成，下文中会详细介绍这个方法。</p>
</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Return the first valid RaycastResult.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> RaycastResult <span class="title">FindFirstRaycast</span>(<span class="params">List&lt;RaycastResult&gt; candidates</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; candidates.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (candidates[i].gameObject == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> candidates[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RaycastResult();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Given an input movement, determine the best MoveDirection.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;x&quot;&gt;</span>X movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;y&quot;&gt;</span>Y movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> MoveDirection <span class="title">DetermineMoveDirection</span>(<span class="params"><span class="built_in">float</span> x, <span class="built_in">float</span> y</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> DetermineMoveDirection(x, y, <span class="number">0.6f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Given an input movement, determine the best MoveDirection.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;x&quot;&gt;</span>X movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;y&quot;&gt;</span>Y movement.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;deadZone&quot;&gt;</span>Dead zone.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> MoveDirection <span class="title">DetermineMoveDirection</span>(<span class="params"><span class="built_in">float</span> x, <span class="built_in">float</span> y, <span class="built_in">float</span> deadZone</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// if vector is too small... just return</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">new</span> Vector2(x, y).sqrMagnitude &lt; deadZone * deadZone)</span><br><span class="line">        <span class="keyword">return</span> MoveDirection.None;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Mathf.Abs(x) &gt; Mathf.Abs(y))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> MoveDirection.Right;</span><br><span class="line">        <span class="keyword">return</span> MoveDirection.Left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (y &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> MoveDirection.Up;</span><br><span class="line">        <span class="keyword">return</span> MoveDirection.Down;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Given 2 GameObjects, return a common root GameObject (or null).</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;g1&quot;&gt;</span>GameObject to compare<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;g2&quot;&gt;</span>GameObject to compare<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> GameObject <span class="title">FindCommonRoot</span>(<span class="params">GameObject g1, GameObject g2</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (g1 == <span class="literal">null</span> || g2 == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> t1 = g1.transform;</span><br><span class="line">    <span class="keyword">while</span> (t1 != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> t2 = g2.transform;</span><br><span class="line">        <span class="keyword">while</span> (t2 != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (t1 == t2)</span><br><span class="line">                <span class="keyword">return</span> t1.gameObject;</span><br><span class="line">            t2 = t2.parent;</span><br><span class="line">        &#125;</span><br><span class="line">        t1 = t1.parent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// walk up the tree till a common root between the last entered and the current entered is foung</span></span><br><span class="line"><span class="comment">// send exit events up to (but not inluding) the common root. Then send enter events up to</span></span><br><span class="line"><span class="comment">// (but not including the common root).</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">HandlePointerExitAndEnter</span>(<span class="params">PointerEventData currentPointerData, GameObject newEnterTarget</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// if we have no target / pointerEnter has been deleted</span></span><br><span class="line">    <span class="comment">// just send exit events to anything we are tracking</span></span><br><span class="line">    <span class="comment">// then exit</span></span><br><span class="line">    <span class="keyword">if</span> (newEnterTarget == <span class="literal">null</span> || currentPointerData.pointerEnter == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; currentPointerData.hovered.Count; ++i)</span><br><span class="line">            ExecuteEvents.Execute(currentPointerData.hovered[i], currentPointerData, ExecuteEvents.pointerExitHandler);</span><br><span class="line"></span><br><span class="line">        currentPointerData.hovered.Clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newEnterTarget == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            currentPointerData.pointerEnter = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we have not changed hover target</span></span><br><span class="line">    <span class="keyword">if</span> (currentPointerData.pointerEnter == newEnterTarget &amp;&amp; newEnterTarget)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    GameObject commonRoot = FindCommonRoot(currentPointerData.pointerEnter, newEnterTarget);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// and we already an entered object from last time</span></span><br><span class="line">    <span class="keyword">if</span> (currentPointerData.pointerEnter != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// send exit handler call to all elements in the chain</span></span><br><span class="line">        <span class="comment">// until we reach the new target, or null!</span></span><br><span class="line">        Transform t = currentPointerData.pointerEnter.transform;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (t != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// if we reach the common root break out!</span></span><br><span class="line">            <span class="keyword">if</span> (commonRoot != <span class="literal">null</span> &amp;&amp; commonRoot.transform == t)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            ExecuteEvents.Execute(t.gameObject, currentPointerData, ExecuteEvents.pointerExitHandler);</span><br><span class="line">            currentPointerData.hovered.Remove(t.gameObject);</span><br><span class="line">            t = t.parent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now issue the enter call up to but not including the common root</span></span><br><span class="line">    currentPointerData.pointerEnter = newEnterTarget;</span><br><span class="line">    <span class="keyword">if</span> (newEnterTarget != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Transform t = newEnterTarget.transform;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (t != <span class="literal">null</span> &amp;&amp; t.gameObject != commonRoot)</span><br><span class="line">        &#123;</span><br><span class="line">            ExecuteEvents.Execute(t.gameObject, currentPointerData, ExecuteEvents.pointerEnterHandler);</span><br><span class="line">            currentPointerData.hovered.Add(t.gameObject);</span><br><span class="line">            t = t.parent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PointerInputModule">PointerInputModule</h3>
<p><code>PointerInputModule</code> 是由 <code>BaseInputModule</code> 派生出来的一个子类，用于处理鼠标、触摸等指针输入。<code>PointerInputModule</code> 中定义了一系列的属性和方法，用于处理指针输入事件。</p>
<p>平心而论，这部分的代码写的还是比较糟糕的，很多地方并没有做到高内聚低耦合。例如 <code>PointerInputModule</code> 定义了一个 <code>protected void CopyFromTo(PointerEventData @from, PointerEventData @to)</code> 方法，用于复制一个 <code>PointerEventData</code> 对象的属性到另一个 <code>PointerEventData</code> 对象中。写过 C++ 的同学应该非常熟悉这个操作，<code>operator=</code> 嘛，因此就更不应该放在这里了，而是应该直接放在 <code>PointerEventData</code> 类中；再比如，由于类中需要维护一个鼠标的所有按键对应的事件，因此定义了一堆类，只为了存放一个 <code>m_MouseState</code> 对象，带来的结果就是可读性非常差。</p>
<p>但既然是学习 UGUI，我们就还是要一点点地分析这部分的实现。这里就不贴完整代码了，直接开始分析。</p>
<p>首先，类中分别为鼠标的三个按键及触摸板定义了一些常量，用于标识这些按键的 ID。此外，类中定义了一个 <code>Dictionary&lt;int, PointerEventData&gt;</code> 类型的字典 <code>m_PointerData</code>，用于缓存当前的按键对应的事件数据。这里也是使用了缓存的设计，提前分配了 <code>m_PointerData</code> 的内存，供后续使用。</p>
<p><code>GetPointerData</code> 方法用于从缓存中获取当前的事件数据。如果缓存中没有对应的事件数据，则会创建一个新的事件数据，并将其添加到缓存中。<code>RemovePointerData</code> 方法用于从缓存中移除指定的事件数据。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Id of the cached left mouse pointer event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> kMouseLeftId = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Id of the cached right mouse pointer event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> kMouseRightId = <span class="number">-2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Id of the cached middle mouse pointer event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> kMouseMiddleId = <span class="number">-3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Touch id for when simulating touches on a non touch device.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> kFakeTouchesId = <span class="number">-4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Dictionary&lt;<span class="built_in">int</span>, PointerEventData&gt; m_PointerData = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, PointerEventData&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Search the cache for currently active pointers, return true if found.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span>Touch ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span>Found data<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;create&quot;&gt;</span>If not found should it be created<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>True if pointer is found.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">GetPointerData</span>(<span class="params"><span class="built_in">int</span> id, <span class="keyword">out</span> PointerEventData data, <span class="built_in">bool</span> create</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!m_PointerData.TryGetValue(id, <span class="keyword">out</span> data) &amp;&amp; create)</span><br><span class="line">    &#123;</span><br><span class="line">        data = <span class="keyword">new</span> PointerEventData(eventSystem)</span><br><span class="line">        &#123;</span><br><span class="line">            pointerId = id,</span><br><span class="line">        &#125;;</span><br><span class="line">        m_PointerData.Add(id, data);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Remove the PointerEventData from the cache.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">RemovePointerData</span>(<span class="params">PointerEventData data</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    m_PointerData.Remove(data.pointerId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是一些将触摸输入或鼠标输入转换为对应事件的方法。首先来看 <code>GetTouchPointerEventData</code> 方法。</p>
<h4 id="GetTouchPointerEventData">GetTouchPointerEventData</h4>
<p><code>GetTouchPointerEventData</code> 方法用于将触摸事件转换为 <code>PointerEventData</code> 对象。该方法会根据传入的 <code>input</code> 变量，判断当前是否按下或释放，并将触摸事件的位置、位移、按钮等信息填充到 <code>PointerEventData</code> 对象中。最后，会调用 <code>eventSystem.RaycastAll</code> 及 <code>FindFirstRaycast</code> 方法，获取当前触摸事件对应的射线检测结果，并将其填充到 <code>PointerEventData</code> 对象中。</p>
<p>其中，函数的后两个参数被标记为 <code>out</code>，表示这两个参数是输出参数，用于返回当前触摸事件是否按下或释放。这种设计方式减少了函数的返回值，提高了代码的可读性。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Given a touch populate the PointerEventData and return if we are pressed or released.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>Touch being processed<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pressed&quot;&gt;</span>Are we pressed this frame<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;released&quot;&gt;</span>Are we released this frame<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> PointerEventData <span class="title">GetTouchPointerEventData</span>(<span class="params">Touch input, <span class="keyword">out</span> <span class="built_in">bool</span> pressed, <span class="keyword">out</span> <span class="built_in">bool</span> released</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    PointerEventData pointerData;</span><br><span class="line">    <span class="keyword">var</span> created = GetPointerData(input.fingerId, <span class="keyword">out</span> pointerData, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    pointerData.Reset();</span><br><span class="line"></span><br><span class="line">    pressed = created || (input.phase == TouchPhase.Began);</span><br><span class="line">    released = (input.phase == TouchPhase.Canceled) || (input.phase == TouchPhase.Ended);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (created)</span><br><span class="line">        pointerData.position = input.position;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pressed)</span><br><span class="line">        pointerData.delta = Vector2.zero;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pointerData.delta = input.position - pointerData.position;</span><br><span class="line"></span><br><span class="line">    pointerData.position = input.position;</span><br><span class="line"></span><br><span class="line">    pointerData.button = PointerEventData.InputButton.Left;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (input.phase == TouchPhase.Canceled)</span><br><span class="line">    &#123;</span><br><span class="line">        pointerData.pointerCurrentRaycast = <span class="keyword">new</span> RaycastResult();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        eventSystem.RaycastAll(pointerData, m_RaycastResultCache);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> raycast = FindFirstRaycast(m_RaycastResultCache);</span><br><span class="line">        pointerData.pointerCurrentRaycast = raycast;</span><br><span class="line">        m_RaycastResultCache.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pointerData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GetMousePointerEventData">GetMousePointerEventData</h4>
<p>接下来是 <code>GetMousePointerEventData</code> 方法。由于鼠标有三个按键，且每个按键都有按下、释放等状态，为了维护鼠标整体的状态，这里定义了许多辅助函数及辅助的类。让我们依次分析：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Copy one PointerEventData to another.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">CopyFromTo</span>(<span class="params">PointerEventData @<span class="keyword">from</span>, PointerEventData @to</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    @to.position = @from.position;</span><br><span class="line">    @to.delta = @from.delta;</span><br><span class="line">    @to.scrollDelta = @from.scrollDelta;</span><br><span class="line">    @to.pointerCurrentRaycast = @from.pointerCurrentRaycast;</span><br><span class="line">    @to.pointerEnter = @from.pointerEnter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Given a mouse button return the current state for the frame.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;buttonId&quot;&gt;</span>Mouse button ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="keyword">protected</span> PointerEventData.<span class="function">FramePressState <span class="title">StateForMouseButton</span>(<span class="params"><span class="built_in">int</span> buttonId</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> pressed = input.GetMouseButtonDown(buttonId);</span><br><span class="line">    <span class="keyword">var</span> released = input.GetMouseButtonUp(buttonId);</span><br><span class="line">    <span class="keyword">if</span> (pressed &amp;&amp; released)</span><br><span class="line">        <span class="keyword">return</span> PointerEventData.FramePressState.PressedAndReleased;</span><br><span class="line">    <span class="keyword">if</span> (pressed)</span><br><span class="line">        <span class="keyword">return</span> PointerEventData.FramePressState.Pressed;</span><br><span class="line">    <span class="keyword">if</span> (released)</span><br><span class="line">        <span class="keyword">return</span> PointerEventData.FramePressState.Released;</span><br><span class="line">    <span class="keyword">return</span> PointerEventData.FramePressState.NotChanged;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CopyFromTo</code> 方法用于将一个 <code>PointerEventData</code> 对象的属性复制到另一个 <code>PointerEventData</code> 对象中。这个方法在 <code>GetMousePointerEventData</code> 方法中会被频繁调用，用于复制当前鼠标按键的状态。</p>
<p><code>StateForMouseButton</code> 方法用于根据鼠标按键的 ID，返回当前按键的状态。这个方法会调用 <code>input.GetMouseButtonDown</code> 和 <code>input.GetMouseButtonUp</code> 方法，判断当前按键是否按下或释放。最后，根据按键的状态，返回对应的 <code>PointerEventData.FramePressState</code> 枚举值。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> MouseState m_MouseState = <span class="keyword">new</span> MouseState();</span><br></pre></td></tr></table></figure>
<p>接下来类中维护了一个 <code>MouseState</code> 类型的对象 <code>m_MouseState</code>，用于存储鼠标的状态。<code>MouseState</code> 类型定义了一个 <code>ButtonState</code> 类型的数组，用于存储鼠标的三个按键的状态，并向外提供了获取及设置这些按键状态的接口。这些类之间的依赖关系如下图所示：</p>
<p><img src="https://s2.loli.net/2024/08/28/MvFz6B3y5D84WAE.png" alt="mouseState.drawio 1.png"></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Return the current MouseState.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> MouseState <span class="title">GetMousePointerEventData</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Populate the left button...</span></span><br><span class="line">    PointerEventData leftData;</span><br><span class="line">    <span class="keyword">var</span> created = GetPointerData(kMouseLeftId, <span class="keyword">out</span> leftData, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    leftData.Reset();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (created)</span><br><span class="line">        leftData.position = input.mousePosition;</span><br><span class="line"></span><br><span class="line">    Vector2 pos = input.mousePosition;</span><br><span class="line">    <span class="keyword">if</span> (Cursor.lockState == CursorLockMode.Locked)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// We don&#x27;t want to do ANY cursor-based interaction when the mouse is locked</span></span><br><span class="line">        leftData.position = <span class="keyword">new</span> Vector2(<span class="number">-1.0f</span>, <span class="number">-1.0f</span>);</span><br><span class="line">        leftData.delta = Vector2.zero;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        leftData.delta = pos - leftData.position;</span><br><span class="line">        leftData.position = pos;</span><br><span class="line">    &#125;</span><br><span class="line">    leftData.scrollDelta = input.mouseScrollDelta;</span><br><span class="line">    leftData.button = PointerEventData.InputButton.Left;</span><br><span class="line">    eventSystem.RaycastAll(leftData, m_RaycastResultCache);</span><br><span class="line">    <span class="keyword">var</span> raycast = FindFirstRaycast(m_RaycastResultCache);</span><br><span class="line">    leftData.pointerCurrentRaycast = raycast;</span><br><span class="line">    m_RaycastResultCache.Clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy the apropriate data into right and middle slots</span></span><br><span class="line">    PointerEventData rightData;</span><br><span class="line">    GetPointerData(kMouseRightId, <span class="keyword">out</span> rightData, <span class="literal">true</span>);</span><br><span class="line">    CopyFromTo(leftData, rightData);</span><br><span class="line">    rightData.button = PointerEventData.InputButton.Right;</span><br><span class="line"></span><br><span class="line">    PointerEventData middleData;</span><br><span class="line">    GetPointerData(kMouseMiddleId, <span class="keyword">out</span> middleData, <span class="literal">true</span>);</span><br><span class="line">    CopyFromTo(leftData, middleData);</span><br><span class="line">    middleData.button = PointerEventData.InputButton.Middle;</span><br><span class="line"></span><br><span class="line">    m_MouseState.SetButtonState(PointerEventData.InputButton.Left, StateForMouseButton(<span class="number">0</span>), leftData);</span><br><span class="line">    m_MouseState.SetButtonState(PointerEventData.InputButton.Right, StateForMouseButton(<span class="number">1</span>), rightData);</span><br><span class="line">    m_MouseState.SetButtonState(PointerEventData.InputButton.Middle, StateForMouseButton(<span class="number">2</span>), middleData);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> m_MouseState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析完了上述的辅助类后，终于可以来看 <code>GetMousePointerEventData</code> 方法了。该方法用于获取当前的鼠标状态。</p>
<p>首先，通过 <code>GetPointerData</code> 方法获取当前鼠标左键对应的事件数据，由上述分析可知，这里使用了缓存的设计。接着，会根据当前的 <code>input</code> 变量，将鼠标的位置、位移、滚轮滚动等信息填充到 <code>PointerEventData</code> 对象中。接下来，会调用 <code>eventSystem.RaycastAll</code> 及 <code>FindFirstRaycast</code> 方法，获取当前鼠标事件对应的射线检测结果，并将其填充到 <code>PointerEventData</code> 对象中。</p>
<p>对于中键和右键，会调用 <code>GetPointerData</code> 方法获取当前鼠标中键和右键对应的事件数据，并调用 <code>CopyFromTo</code> 方法将左键的事件数据复制到中键和右键的事件数据中。最后，会调用 <code>StateForMouseButton</code> 方法，获取当前中键和右键的状态，并调用 <code>m_MouseState.SetButtonState</code> 方法，设置中键和右键的状态。</p>
<p>完成了这些操作后，就可以返回当前的鼠标状态了。这里也使用了缓存的设计，将状态全部更新至 <code>m_MouseState</code> 对象中，供后续使用。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Process movement for the current frame with the given pointer event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ProcessMove</span>(<span class="params">PointerEventData pointerEvent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> targetGO = (Cursor.lockState == CursorLockMode.Locked ? <span class="literal">null</span> : pointerEvent.pointerCurrentRaycast.gameObject);</span><br><span class="line">    HandlePointerExitAndEnter(pointerEvent, targetGO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Process the drag for the current frame with the given pointer event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ProcessDrag</span>(<span class="params">PointerEventData pointerEvent</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!pointerEvent.IsPointerMoving() ||</span><br><span class="line">        Cursor.lockState == CursorLockMode.Locked ||</span><br><span class="line">        pointerEvent.pointerDrag == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pointerEvent.dragging</span><br><span class="line">        &amp;&amp; ShouldStartDrag(pointerEvent.pressPosition, pointerEvent.position, eventSystem.pixelDragThreshold, pointerEvent.useDragThreshold))</span><br><span class="line">    &#123;</span><br><span class="line">        ExecuteEvents.Execute(pointerEvent.pointerDrag, pointerEvent, ExecuteEvents.beginDragHandler);</span><br><span class="line">        pointerEvent.dragging = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Drag notification</span></span><br><span class="line">    <span class="keyword">if</span> (pointerEvent.dragging)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Before doing drag we should cancel any pointer down state</span></span><br><span class="line">        <span class="comment">// And clear selection!</span></span><br><span class="line">        <span class="keyword">if</span> (pointerEvent.pointerPress != pointerEvent.pointerDrag)</span><br><span class="line">        &#123;</span><br><span class="line">            ExecuteEvents.Execute(pointerEvent.pointerPress, pointerEvent, ExecuteEvents.pointerUpHandler);</span><br><span class="line"></span><br><span class="line">            pointerEvent.eligibleForClick = <span class="literal">false</span>;</span><br><span class="line">            pointerEvent.pointerPress = <span class="literal">null</span>;</span><br><span class="line">            pointerEvent.rawPointerPress = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ExecuteEvents.Execute(pointerEvent.pointerDrag, pointerEvent, ExecuteEvents.dragHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来有一些对应事件的处理方法，总体来说都是调用与事件类型对应的 <code>ExecuteEvents.Execute</code> 方法。</p>
<p>到这里我们就分析完了 <code>PointerInputModule</code> 类的基本内容，可以看到，<code>PointerInputModule</code> 类将鼠标、触摸等按键的输入转换为了对应的时间数据，并已经定义了相应的处理方法，看上去已经可以处理用户输入了。</p>
<p>然而，<code>PointerInputModule</code> 类依然是一个抽象类，并没有实现 <code>BaseInputModule</code> 中定义的 <code>Process</code> 方法。因此，还需要继承 <code>PointerInputModule</code> 类，并实现 <code>Process</code> 方法，才能真正处理用户的输入事件。</p>
<h3 id="StandaloneInputModule">StandaloneInputModule</h3>
<p><img src="https://s2.loli.net/2024/08/28/SYoE8a7WNgBDFRL.png" alt="image.png"></p>
<p>由类图可知，Unity 中自带两个从 <code>PointerInputModule</code> 派生出的处理输入的类：<code>StandaloneInputModule</code> 与 <code>TouchInputModule</code>。后者已经被禁用，现在所有的输入均由 <code>StandaloneInputModule</code> 一个类处理。从类的注释中我们也可以得到相同的结论：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AddComponentMenu(<span class="string">&quot;Event/Standalone Input Module&quot;</span>)</span>]</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> A BaseInputModule designed for mouse / keyboard / controller input.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Input module for working with, mouse, keyboard, or controller.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StandaloneInputModule</span> : <span class="title">PointerInputModule</span></span><br></pre></td></tr></table></figure>
<p>由前文对 <code>EvenySystem</code> 的分析可知，该类会逐帧调用 GameObject 上挂载的 <code>InputModule</code> 中的 <code>UpdateModule()</code> 及 <code>Process()</code> 方法以处理用户输入。因此针对 <code>StandaloneInputModule</code>，我们业主要分析这两部分的实现。</p>
<h4 id="UpdateModule">UpdateModule</h4>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">UpdateModule</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!eventSystem.isFocused &amp;&amp; ShouldIgnoreEventsOnNoFocus())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_InputPointerEvent != <span class="literal">null</span> &amp;&amp; m_InputPointerEvent.pointerDrag != <span class="literal">null</span> &amp;&amp; m_InputPointerEvent.dragging)</span><br><span class="line">        &#123;</span><br><span class="line">            ReleaseMouse(m_InputPointerEvent, m_InputPointerEvent.pointerCurrentRaycast.gameObject);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_InputPointerEvent = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_LastMousePosition = m_MousePosition;</span><br><span class="line">    m_MousePosition = input.mousePosition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReleaseMouse</span>(<span class="params">PointerEventData pointerEvent, GameObject currentOverGo</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ExecuteEvents.Execute(pointerEvent.pointerPress, pointerEvent, ExecuteEvents.pointerUpHandler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pointerUpHandler = ExecuteEvents.GetEventHandler&lt;IPointerClickHandler&gt;(currentOverGo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PointerClick and Drop events</span></span><br><span class="line">    <span class="keyword">if</span> (pointerEvent.pointerPress == pointerUpHandler &amp;&amp; pointerEvent.eligibleForClick)</span><br><span class="line">    &#123;</span><br><span class="line">        ExecuteEvents.Execute(pointerEvent.pointerPress, pointerEvent, ExecuteEvents.pointerClickHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pointerEvent.pointerDrag != <span class="literal">null</span> &amp;&amp; pointerEvent.dragging)</span><br><span class="line">    &#123;</span><br><span class="line">        ExecuteEvents.ExecuteHierarchy(currentOverGo, pointerEvent, ExecuteEvents.dropHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pointerEvent.eligibleForClick = <span class="literal">false</span>;</span><br><span class="line">    pointerEvent.pointerPress = <span class="literal">null</span>;</span><br><span class="line">    pointerEvent.rawPointerPress = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pointerEvent.pointerDrag != <span class="literal">null</span> &amp;&amp; pointerEvent.dragging)</span><br><span class="line">        ExecuteEvents.Execute(pointerEvent.pointerDrag, pointerEvent, ExecuteEvents.endDragHandler);</span><br><span class="line"></span><br><span class="line">    pointerEvent.dragging = <span class="literal">false</span>;</span><br><span class="line">    pointerEvent.pointerDrag = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// redo pointer enter / exit to refresh state</span></span><br><span class="line">    <span class="comment">// so that if we moused over something that ignored it before</span></span><br><span class="line">    <span class="comment">// due to having pressed on something else</span></span><br><span class="line">    <span class="comment">// it now gets it.</span></span><br><span class="line">    <span class="keyword">if</span> (currentOverGo != pointerEvent.pointerEnter)</span><br><span class="line">    &#123;</span><br><span class="line">        HandlePointerExitAndEnter(pointerEvent, <span class="literal">null</span>);</span><br><span class="line">        HandlePointerExitAndEnter(pointerEvent, currentOverGo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_InputPointerEvent = pointerEvent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>UpdateModule</code> 方法会在每一帧被调用，用于更新鼠标的位置及其他的类内状态。特别地，如果当前的 <code>EventSystem</code> 失去了焦点，且 <code>ShouldIgnoreEventsOnNoFocus</code> 方法返回 <code>true</code>，则会调用 <code>ReleaseMouse</code> 方法释放鼠标。</p>
<h4 id="Process">Process</h4>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Process</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!eventSystem.isFocused &amp;&amp; ShouldIgnoreEventsOnNoFocus())</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> usedEvent = SendUpdateEventToSelectedObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// case 1004066 - touch / mouse events should be processed before navigation events in case</span></span><br><span class="line">    <span class="comment">// they change the current selected gameobject and the submit button is a touch / mouse button.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// touch needs to take precedence because of the mouse emulation layer</span></span><br><span class="line">    <span class="keyword">if</span> (!ProcessTouchEvents() &amp;&amp; input.mousePresent)</span><br><span class="line">        ProcessMouseEvent();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eventSystem.sendNavigationEvents)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!usedEvent)</span><br><span class="line">            usedEvent |= SendMoveEventToSelectedObject();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!usedEvent)</span><br><span class="line">            SendSubmitEventToSelectedObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Process</code> 方法会在每一帧被调用，用于处理当前的输入事件。该方法会首先调用 <code>SendUpdateEventToSelectedObject</code> 方法，发送更新事件给当前选中的对象。接着，会调用 <code>ProcessTouchEvents</code> 方法处理触摸事件，如果触摸事件处理完毕，则会调用 <code>ProcessMouseEvent</code> 方法处理鼠标事件。最后，如果 <code>eventSystem.sendNavigationEvents</code> 为 <code>true</code>，则会调用 <code>SendMoveEventToSelectedObject</code> 方法发送移动事件给当前选中的对象，以及调用 <code>SendSubmitEventToSelectedObject</code> 方法发送提交事件给当前选中的对象。</p>
<p>这里多次使用了 <code>usedEvent</code> 变量，用于标识当前的事件是否被处理。如果事件被处理，则会将 <code>usedEvent</code> 置为 <code>true</code>，表示当前的事件无需进一步处理。</p>
<p>来看一下 <code>ProcessTouchEvents</code> 及 <code>ProcessMouseEvent</code> 方法的实现。</p>
<h4 id="ProcessTouchEvents">ProcessTouchEvents</h4>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">ProcessTouchEvents</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; input.touchCount; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        Touch touch = input.GetTouch(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (touch.type == TouchType.Indirect)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">bool</span> released;</span><br><span class="line">        <span class="built_in">bool</span> pressed;</span><br><span class="line">        <span class="keyword">var</span> pointer = GetTouchPointerEventData(touch, <span class="keyword">out</span> pressed, <span class="keyword">out</span> released);</span><br><span class="line"></span><br><span class="line">        ProcessTouchPress(pointer, pressed, released);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!released)</span><br><span class="line">        &#123;</span><br><span class="line">            ProcessMove(pointer);</span><br><span class="line">            ProcessDrag(pointer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            RemovePointerData(pointer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> input.touchCount &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ProcessTouchEvents</code> 方法用于处理触摸事件。该方法会遍历当前的触摸事件，调用 <code>GetTouchPointerEventData</code> 方法将触摸事件转换为 <code>PointerEventData</code> 对象。接着，会调用 <code>ProcessTouchPress</code> 方法处理触摸事件的按下和释放。如果触摸事件未释放，则会调用 <code>ProcessMove</code> 及 <code>ProcessDrag</code> 方法处理触摸事件的移动和拖拽。最后，如果触摸事件已释放，则会调用 <code>RemovePointerData</code> 方法移除对应的事件数据。</p>
<p>有以下几点需要注意：</p>
<ol>
<li>
<p><code>ProcessTouchEvents</code> 整体使用了一个 for 循环来处理所有的触摸事件，这样可以应对诸如多点触控等复杂的触摸事件。</p>
</li>
<li>
<p><code>ProcessTouchEvents</code> 方法中使用了在 <code>PointerInputModule</code> 类中定义的 <code>GetTouchPointerEventData</code> 方法，用于将触摸事件转换为 <code>PointerEventData</code> 对象。此外，<code>ProcessMove</code>、<code>ProcessDrag</code> 及 <code>RemovePointerData</code> 方法也是在 <code>PointerInputModule</code> 类中定义的，用于处理触摸事件的移动、拖拽及释放当前事件。</p>
</li>
<li>
<p><code>ProcessTouchPress</code> 方法用于处理触摸事件的按下和释放。这个方法会根据触摸事件的按下和释放状态，调用 <code>ExecuteEvents.Execute</code> 方法，发送按下和释放事件。</p>
</li>
</ol>
<h4 id="ProcessMouseEvent">ProcessMouseEvent</h4>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ProcessMouseEvent</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ProcessMouseEvent(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Process all mouse events.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ProcessMouseEvent</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> mouseData = GetMousePointerEventData(id);</span><br><span class="line">    <span class="keyword">var</span> leftButtonData = mouseData.GetButtonState(PointerEventData.InputButton.Left).eventData;</span><br><span class="line"></span><br><span class="line">    m_CurrentFocusedGameObject = leftButtonData.buttonData.pointerCurrentRaycast.gameObject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process the first mouse button fully</span></span><br><span class="line">    ProcessMousePress(leftButtonData);</span><br><span class="line">    ProcessMove(leftButtonData.buttonData);</span><br><span class="line">    ProcessDrag(leftButtonData.buttonData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now process right / middle clicks</span></span><br><span class="line">    ProcessMousePress(mouseData.GetButtonState(PointerEventData.InputButton.Right).eventData);</span><br><span class="line">    ProcessDrag(mouseData.GetButtonState(PointerEventData.InputButton.Right).eventData.buttonData);</span><br><span class="line">    ProcessMousePress(mouseData.GetButtonState(PointerEventData.InputButton.Middle).eventData);</span><br><span class="line">    ProcessDrag(mouseData.GetButtonState(PointerEventData.InputButton.Middle).eventData.buttonData);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!Mathf.Approximately(leftButtonData.buttonData.scrollDelta.sqrMagnitude, <span class="number">0.0f</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> scrollHandler = ExecuteEvents.GetEventHandler&lt;IScrollHandler&gt;(leftButtonData.buttonData.pointerCurrentRaycast.gameObject);</span><br><span class="line">        ExecuteEvents.ExecuteHierarchy(scrollHandler, leftButtonData.buttonData, ExecuteEvents.scrollHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ProcessMouseEvent</code> 方法用于处理鼠标事件。该方法会首先调用 <code>GetMousePointerEventData</code> 方法获取当前的鼠标状态。接着，会调用 <code>ProcessMousePress</code> 方法处理鼠标事件的按下和释放。如果鼠标事件未释放，则会调用 <code>ProcessMove</code> 及 <code>ProcessDrag</code> 方法处理鼠标事件的移动和拖拽。最后，如果鼠标事件有滚动，则会调用 <code>ExecuteEvents.ExecuteHierarchy</code> 方法，发送滚动事件。</p>
<p>有以下几点需要注意：</p>
<ol>
<li>
<p><code>ProcessMouseEvent</code> 方法中使用了在 <code>PointerInputModule</code> 类中定义的 <code>GetMousePointerEventData</code> 方法，用于获取当前的鼠标状态。此外，该函数也使用了在 <code>PointerInputModule</code> 类中定义的 <code>ProcessMove</code> 及 <code>ProcessDrag</code> 方法，用于处理鼠标事件的移动和拖拽。</p>
</li>
<li>
<p><code>ProcessMouseEvent</code> 方法中调用了 <code>ProcessMousePress</code> 方法，用于处理鼠标事件的按下和释放。这个方法会根据鼠标事件的按下和释放状态，调用 <code>ExecuteEvents.Execute</code> 方法，发送按下和释放事件。</p>
</li>
<li>
<p>可以看出除了 <code>ProcessMove</code> 外，<code>ProcessMousePress</code> 及 <code>ProcessDrag</code> 都调用了三次，分别处理鼠标的左键、右键和中键。这主要是因为鼠标的移动是一个整体的事件，只需处理一次，而不同按键的按下和释放事件是独立的，因此需要分别处理。</p>
</li>
</ol>
<h3 id="小结-2">小结</h3>
<p>以上我们就分析完了 <code>InputModule</code> 的相关内容。总体而言，<code>InputModule</code> 类主要用于处理用户的输入事件，将用户的输入事件转换为对应的事件数据，并调用 <code>ExecuteEvents.Execute</code> 方法，发送事件给对应的 <code>GameObject</code>。</p>
<p>其中，<code>BaseInput</code> 负责存放一次输入的相关数据，包括如鼠标位置、滚动、存在状态等；<code>EventData</code> 封装了一次输入的事件数据，负责在 <code>EventSystem</code> 中传递事件信息。<code>InputModule</code> 负责处理用户的输入事件，将用户的输入事件转换为对应的事件数据，并根据输入的类型（如按下、释放、移动等）调用对应的 <code>ExecuteEvents.Execute</code> 方法，发送事件给对应的 <code>GameObject</code>。</p>
<p>距离我们分析完整个 <code>EventSystem</code> 还有两部分内容：获取当前物体的 <code>Raycast</code> 及负责处理各种事件的 <code>ExecuteEvents</code>，让我们继续往下看。</p>
<h2 id="Raycasters">Raycasters</h2>
<p>在上文的分析中我们可以多次看到 <code>RaycastAll()</code> 以及 <code>FindFirstRaycast()</code> 方法，这些方法都是使用射线检测来获取当前的物体。下面就来分析射线检测模块的实现。</p>
<h3 id="RaycastResult">RaycastResult</h3>
<p>与 <code>BaseInput</code>、<code>EventData</code> 类似，射线检测模块也定义了自己的数据结构以用于存储射线检测的结果，这便是 <code>RaycastResult</code> 类。<code>RaycastResult</code> 类的定义如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> A hit result from a BaseRaycaster.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> RaycastResult</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> GameObject m_GameObject; <span class="comment">// Game object hit by the raycast</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The GameObject that was hit by the raycast.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> GameObject gameObject</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> m_GameObject; &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; m_GameObject = <span class="keyword">value</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> BaseRaycaster that raised the hit.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseRaycaster module;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Distance to the hit.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> distance;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Hit index</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> index;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Used by raycasters where elements may have the same unit distance, but have specific ordering.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> depth;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The SortingLayer of the hit object.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> For UI.Graphic elements this will be the values from that graphic&#x27;s Canvas</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> For 3D objects this will always be 0.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> For 2D objects if a SpriteRenderer is attached to the same object as the hit collider that SpriteRenderer sortingLayerID will be used.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> sortingLayer;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The SortingOrder for the hit object.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> For Graphic elements this will be the values from that graphics Canvas</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> For 3D objects this will always be 0.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> For 2D objects if a SpriteRenderer is attached to the same object as the hit collider that SpriteRenderer sortingOrder will be used.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> sortingOrder;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The world position of the where the raycast has hit.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 worldPosition;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The normal at the hit location of the raycast.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector3 worldNormal;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The screen position from which the raycast was generated.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Vector2 screenPosition;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Is there an associated module and a hit GameObject.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> isValid</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> module != <span class="literal">null</span> &amp;&amp; gameObject != <span class="literal">null</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Reset the result.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        gameObject = <span class="literal">null</span>;</span><br><span class="line">        module = <span class="literal">null</span>;</span><br><span class="line">        distance = <span class="number">0</span>;</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        depth = <span class="number">0</span>;</span><br><span class="line">        sortingLayer = <span class="number">0</span>;</span><br><span class="line">        sortingOrder = <span class="number">0</span>;</span><br><span class="line">        worldNormal = Vector3.up;</span><br><span class="line">        worldPosition = Vector3.zero;</span><br><span class="line">        screenPosition = Vector2.zero;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中存放了射线检测的结果，包括检测到的物体、射线检测的距离、检测到的物体的深度等信息。此外，其中还有一个 <code>module</code> 属性用于存放产生这次结果的射线本身。<code>RaycastResult</code> 类还定义了 <code>Clear</code> 方法，用于清空射线检测的结果。</p>
<h3 id="RaycasterManager">RaycasterManager</h3>
<p><code>RaycasterManager</code> 类用于管理所有的射线检测器。<code>RaycasterManager</code> 类是一个静态类，定义了一个 <code>List&lt;BaseRaycaster&gt;</code> 类型的列表 <code>m_Raycasters</code>，用于存放所有的射线检测器。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">RaycasterManager</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> List&lt;BaseRaycaster&gt; s_Raycasters = <span class="keyword">new</span> List&lt;BaseRaycaster&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddRaycaster</span>(<span class="params">BaseRaycaster baseRaycaster</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (s_Raycasters.Contains(baseRaycaster))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        s_Raycasters.Add(baseRaycaster);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;BaseRaycaster&gt; <span class="title">GetRaycasters</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> s_Raycasters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RemoveRaycasters</span>(<span class="params">BaseRaycaster baseRaycaster</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!s_Raycasters.Contains(baseRaycaster))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        s_Raycasters.Remove(baseRaycaster);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>RaycasterManager</code> 类定义了 <code>AddRaycaster</code>、<code>GetRaycasters</code> 及 <code>RemoveRaycasters</code> 方法，用于添加、获取及移除射线检测器。</p>
<h3 id="ReflectionMethodsCache">ReflectionMethodsCache</h3>
<p>正如 <code>BaseInput</code> 本身并不直接处理用户的输入，而是通过 Unity 的 <code>Input</code> 模块获取结果；<code>Raycasters</code> 本身也并不直接处理射线检测，而是通过 <code>Physics</code> 模块直接获取到各种类型射线检测的函数。这些函数就存放在 <code>ReflectionMethodsCache</code> 类中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">ReflectionMethodsCache</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="built_in">bool</span> <span class="title">Raycast3DCallback</span>(<span class="params">Ray r, <span class="keyword">out</span> RaycastHit hit, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> RaycastHit2D <span class="title">Raycast2DCallback</span>(<span class="params">Vector2 p1, Vector2 p2, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> RaycastHit[] <span class="title">RaycastAllCallback</span>(<span class="params">Ray r, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> RaycastHit2D[] <span class="title">GetRayIntersectionAllCallback</span>(<span class="params">Ray r, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="built_in">int</span> <span class="title">GetRayIntersectionAllNonAllocCallback</span>(<span class="params">Ray r, RaycastHit2D[] results, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="built_in">int</span> <span class="title">GetRaycastNonAllocCallback</span>(<span class="params">Ray r, RaycastHit[] results, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We call Physics.Raycast and Physics2D.Raycast through reflection to avoid creating a hard dependency from</span></span><br><span class="line">    <span class="comment">// this class to the Physics/Physics2D modules, which would otherwise make it impossible to make content with UI</span></span><br><span class="line">    <span class="comment">// without force-including both modules.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// *NOTE* If other methods are required ensure to add [RequiredByNativeCode] to the bindings for that function. It prevents</span></span><br><span class="line">    <span class="comment">//        the function from being stripped if required. See Dynamics.bindings.cs for examples (search for GraphicRaycaster.cs).</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReflectionMethodsCache</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> raycast3DMethodInfo = <span class="keyword">typeof</span>(Physics).GetMethod(<span class="string">&quot;Raycast&quot;</span>, <span class="keyword">new</span>[] &#123;<span class="keyword">typeof</span>(Ray), <span class="keyword">typeof</span>(RaycastHit).MakeByRefType(), <span class="keyword">typeof</span>(<span class="built_in">float</span>), <span class="keyword">typeof</span>(<span class="built_in">int</span>)&#125;);</span><br><span class="line">        <span class="keyword">if</span> (raycast3DMethodInfo != <span class="literal">null</span>)</span><br><span class="line">            raycast3D = (Raycast3DCallback)Delegate.CreateDelegate(<span class="keyword">typeof</span>(Raycast3DCallback), raycast3DMethodInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> raycast2DMethodInfo = <span class="keyword">typeof</span>(Physics2D).GetMethod(<span class="string">&quot;Raycast&quot;</span>, <span class="keyword">new</span>[] &#123;<span class="keyword">typeof</span>(Vector2), <span class="keyword">typeof</span>(Vector2), <span class="keyword">typeof</span>(<span class="built_in">float</span>), <span class="keyword">typeof</span>(<span class="built_in">int</span>)&#125;);</span><br><span class="line">        <span class="keyword">if</span> (raycast2DMethodInfo != <span class="literal">null</span>)</span><br><span class="line">            raycast2D = (Raycast2DCallback)Delegate.CreateDelegate(<span class="keyword">typeof</span>(Raycast2DCallback), raycast2DMethodInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> raycastAllMethodInfo = <span class="keyword">typeof</span>(Physics).GetMethod(<span class="string">&quot;RaycastAll&quot;</span>, <span class="keyword">new</span>[] &#123;<span class="keyword">typeof</span>(Ray), <span class="keyword">typeof</span>(<span class="built_in">float</span>), <span class="keyword">typeof</span>(<span class="built_in">int</span>)&#125;);</span><br><span class="line">        <span class="keyword">if</span> (raycastAllMethodInfo != <span class="literal">null</span>)</span><br><span class="line">            raycast3DAll = (RaycastAllCallback)Delegate.CreateDelegate(<span class="keyword">typeof</span>(RaycastAllCallback), raycastAllMethodInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> getRayIntersectionAllMethodInfo = <span class="keyword">typeof</span>(Physics2D).GetMethod(<span class="string">&quot;GetRayIntersectionAll&quot;</span>, <span class="keyword">new</span>[] &#123;<span class="keyword">typeof</span>(Ray), <span class="keyword">typeof</span>(<span class="built_in">float</span>), <span class="keyword">typeof</span>(<span class="built_in">int</span>)&#125;);</span><br><span class="line">        <span class="keyword">if</span> (getRayIntersectionAllMethodInfo != <span class="literal">null</span>)</span><br><span class="line">            getRayIntersectionAll = (GetRayIntersectionAllCallback)Delegate.CreateDelegate(<span class="keyword">typeof</span>(GetRayIntersectionAllCallback), getRayIntersectionAllMethodInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> getRayIntersectionAllNonAllocMethodInfo = <span class="keyword">typeof</span>(Physics2D).GetMethod(<span class="string">&quot;GetRayIntersectionNonAlloc&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="keyword">typeof</span>(Ray), <span class="keyword">typeof</span>(RaycastHit2D[]), <span class="keyword">typeof</span>(<span class="built_in">float</span>), <span class="keyword">typeof</span>(<span class="built_in">int</span>) &#125;);</span><br><span class="line">        <span class="keyword">if</span> (getRayIntersectionAllNonAllocMethodInfo != <span class="literal">null</span>)</span><br><span class="line">            getRayIntersectionAllNonAlloc = (GetRayIntersectionAllNonAllocCallback)Delegate.CreateDelegate(<span class="keyword">typeof</span>(GetRayIntersectionAllNonAllocCallback), getRayIntersectionAllNonAllocMethodInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> getRaycastAllNonAllocMethodInfo = <span class="keyword">typeof</span>(Physics).GetMethod(<span class="string">&quot;RaycastNonAlloc&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="keyword">typeof</span>(Ray), <span class="keyword">typeof</span>(RaycastHit[]), <span class="keyword">typeof</span>(<span class="built_in">float</span>), <span class="keyword">typeof</span>(<span class="built_in">int</span>) &#125;);</span><br><span class="line">        <span class="keyword">if</span> (getRaycastAllNonAllocMethodInfo != <span class="literal">null</span>)</span><br><span class="line">            getRaycastNonAlloc = (GetRaycastNonAllocCallback)Delegate.CreateDelegate(<span class="keyword">typeof</span>(GetRaycastNonAllocCallback), getRaycastAllNonAllocMethodInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Raycast3DCallback raycast3D = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> RaycastAllCallback raycast3DAll = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> Raycast2DCallback raycast2D = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> GetRayIntersectionAllCallback getRayIntersectionAll = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> GetRayIntersectionAllNonAllocCallback getRayIntersectionAllNonAlloc = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> GetRaycastNonAllocCallback getRaycastNonAlloc = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReflectionMethodsCache s_ReflectionMethodsCache = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ReflectionMethodsCache Singleton</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (s_ReflectionMethodsCache == <span class="literal">null</span>)</span><br><span class="line">                s_ReflectionMethodsCache = <span class="keyword">new</span> ReflectionMethodsCache();</span><br><span class="line">            <span class="keyword">return</span> s_ReflectionMethodsCache;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先，可以看到类中定义了一系列的委托，用于存放不同种类的射线检测函数。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="built_in">bool</span> <span class="title">Raycast3DCallback</span>(<span class="params">Ray r, <span class="keyword">out</span> RaycastHit hit, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> RaycastHit2D <span class="title">Raycast2DCallback</span>(<span class="params">Vector2 p1, Vector2 p2, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> RaycastHit[] <span class="title">RaycastAllCallback</span>(<span class="params">Ray r, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> RaycastHit2D[] <span class="title">GetRayIntersectionAllCallback</span>(<span class="params">Ray r, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="built_in">int</span> <span class="title">GetRayIntersectionAllNonAllocCallback</span>(<span class="params">Ray r, RaycastHit2D[] results, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="built_in">int</span> <span class="title">GetRaycastNonAllocCallback</span>(<span class="params">Ray r, RaycastHit[] results, <span class="built_in">float</span> f, <span class="built_in">int</span> i</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>接着，在 <code>ReflectionMethodsCache</code> 类的构造函数中，通过反射获取了 <code>Physics</code> 及 <code>Physics2D</code> 模块中的射线检测函数，并将其赋值给上述定义的委托。这样，<code>ReflectionMethodsCache</code> 类就可以通过委托调用射线检测函数。</p>
<p>在注释中我们可以看到这样做的目的：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// We call Physics.Raycast and Physics2D.Raycast through reflection to avoid creating a hard dependency from</span></span><br><span class="line"><span class="comment">// this class to the Physics/Physics2D modules, which would otherwise make it impossible to make content with UI</span></span><br><span class="line"><span class="comment">// without force-including both modules.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// *NOTE* If other methods are required ensure to add [RequiredByNativeCode] to the bindings for that function. It prevents</span></span><br><span class="line"><span class="comment">//        the function from being stripped if required. See Dynamics.bindings.cs for examples (search for GraphicRaycaster.cs).</span></span><br></pre></td></tr></table></figure>
<p>这样做主要是为了避免 <code>Raycasters</code> 类直接依赖于 <code>Physics</code> 及 <code>Physics2D</code> 模块，这样可以使得 <code>Raycasters</code> 类不依赖于 <code>Physics</code> 及 <code>Physics2D</code> 模块，从而使得 <code>Raycasters</code> 类可以独立于 <code>Physics</code> 及 <code>Physics2D</code> 模块运行。此外，如果需要其他的方法，需要确保在绑定函数中添加 <code>[RequiredByNativeCode]</code>，以防止这个函数被裁剪。</p>
<p><code>ReflectionMethodsCache</code> 是一个单例类，通过 <code>Singleton</code> 属性就可以访问到上述反射出的射线检测函数了。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ReflectionMethodsCache Singleton</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (s_ReflectionMethodsCache == <span class="literal">null</span>)</span><br><span class="line">            s_ReflectionMethodsCache = <span class="keyword">new</span> ReflectionMethodsCache();</span><br><span class="line">        <span class="keyword">return</span> s_ReflectionMethodsCache;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BaseRaycaster-PhysicsRaycaster-Physics2DRaycaster">BaseRaycaster / PhysicsRaycaster / Physics2DRaycaster</h3>
<p><code>BaseRaycaster</code> 类是所有射线检测器的基类，定义了射线检测器的基本属性及方法。<code>BaseRaycaster</code> 类的定义如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Base class for any RayCaster.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> A Raycaster is responsible for raycasting against scene elements to determine if the cursor is over them. Default Raycasters include PhysicsRaycaster, Physics2DRaycaster, GraphicRaycaster.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Custom raycasters can be added by extending this class.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseRaycaster</span> : <span class="title">UIBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> BaseRaycaster m_RootRaycaster;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Raycast against the scene.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventData&quot;&gt;</span>Current event data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;resultAppendList&quot;&gt;</span>List of hit Objects.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Raycast</span>(<span class="params">PointerEventData eventData, List&lt;RaycastResult&gt; resultAppendList</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> The camera that will generate rays for this raycaster.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Camera eventCamera &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Raycaster on root canvas</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> BaseRaycaster rootRaycaster</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_RootRaycaster == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> baseRaycasters = GetComponentsInParent&lt;BaseRaycaster&gt;();</span><br><span class="line">                <span class="keyword">if</span> (baseRaycasters.Length != <span class="number">0</span>)</span><br><span class="line">                    m_RootRaycaster = baseRaycasters[baseRaycasters.Length - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> m_RootRaycaster;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnEnable();</span><br><span class="line">        RaycasterManager.AddRaycaster(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnDisable</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        RaycasterManager.RemoveRaycasters(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">base</span>.OnDisable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnCanvasHierarchyChanged</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnCanvasHierarchyChanged();</span><br><span class="line">        m_RootRaycaster = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnTransformParentChanged</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnTransformParentChanged();</span><br><span class="line">        m_RootRaycaster = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有以下几点需要注意：</p>
<ol>
<li>
<p><code>BaseRaycaster</code> 类是一个抽象类，定义了抽象方法 <code>Raycast</code> 及 <code>eventCamera</code>。<code>Raycast</code> 方法用于射线检测，<code>eventCamera</code> 属性用于获取射线检测的相机。</p>
</li>
<li>
<p><code>BaseRaycaster</code> 会在启用/禁用时调用 <code>RaycasterManager</code> 的 <code>AddRaycaster</code> 及 <code>RemoveRaycasters</code> 方法，用于将自身添加到/移除出射线检测器列表。</p>
</li>
</ol>
<p>至于 <code>PhysicsRaycaster</code> 及 <code>Physics2DRaycaster</code> 类，这两个类分别用于进行 3D 及 2D 的射线检测。他们继承自 <code>BaseRaycaster</code> 类，并实现了 <code>Raycast</code> 及 <code>eventCamera</code> 方法。2D 与 3D 分别使用了 <code>Physics2D/Physics</code> 中射线穿透获取交点信息的方法。</p>
<p>这里以 <code>PhysicsRaycaster.Raycast()</code> 为例分析一下射线检测的过程：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Raycast</span>(<span class="params">PointerEventData eventData, List&lt;RaycastResult&gt; resultAppendList</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Ray ray = <span class="keyword">new</span> Ray();</span><br><span class="line">    <span class="built_in">float</span> distanceToClipPlane = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!ComputeRayAndDistance(eventData, <span class="keyword">ref</span> ray, <span class="keyword">ref</span> distanceToClipPlane))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> hitCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_MaxRayIntersections == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ReflectionMethodsCache.Singleton.raycast3DAll == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        m_Hits = ReflectionMethodsCache.Singleton.raycast3DAll(ray, distanceToClipPlane, finalEventMask);</span><br><span class="line">        hitCount = m_Hits.Length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ReflectionMethodsCache.Singleton.getRaycastNonAlloc == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_LastMaxRayIntersections != m_MaxRayIntersections)</span><br><span class="line">        &#123;</span><br><span class="line">            m_Hits = <span class="keyword">new</span> RaycastHit[m_MaxRayIntersections];</span><br><span class="line">            m_LastMaxRayIntersections = m_MaxRayIntersections;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hitCount = ReflectionMethodsCache.Singleton.getRaycastNonAlloc(ray, m_Hits, distanceToClipPlane, finalEventMask);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hitCount &gt; <span class="number">1</span>)</span><br><span class="line">        System.Array.Sort(m_Hits, (r1, r2) =&gt; r1.distance.CompareTo(r2.distance));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hitCount != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> b = <span class="number">0</span>, bmax = hitCount; b &lt; bmax; ++b)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">new</span> RaycastResult</span><br><span class="line">            &#123;</span><br><span class="line">                gameObject = m_Hits[b].collider.gameObject,</span><br><span class="line">                module = <span class="keyword">this</span>,</span><br><span class="line">                distance = m_Hits[b].distance,</span><br><span class="line">                worldPosition = m_Hits[b].point,</span><br><span class="line">                worldNormal = m_Hits[b].normal,</span><br><span class="line">                screenPosition = eventData.position,</span><br><span class="line">                index = resultAppendList.Count,</span><br><span class="line">                sortingLayer = <span class="number">0</span>,</span><br><span class="line">                sortingOrder = <span class="number">0</span></span><br><span class="line">            &#125;;</span><br><span class="line">            resultAppendList.Add(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，调用了 <code>ComputeRayAndDistance</code> 方法，用于根据 <code>eventData</code> 中点击的位置得到对应的射线，以及射线在前后裁剪平面的距离（关于裁切平面详见<a href="https://qlipphoth.github.io/2023/12/06/2023-12-6-1/">MVP矩阵</a>）。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ray = eventCamera.ScreenPointToRay(eventPosition);</span><br><span class="line"><span class="built_in">float</span> projectionDirection = ray.direction.z;</span><br><span class="line">distanceToClipPlane = Mathf.Approximately(<span class="number">0.0f</span>, projectionDirection)</span><br><span class="line">    ? Mathf.Infinity</span><br><span class="line">    : Mathf.Abs((eventCamera.farClipPlane - eventCamera.nearClipPlane) / projectionDirection);</span><br></pre></td></tr></table></figure>
<p>此后，会调用 <code>ReflectionMethodsCache.Singleton</code> 中相应的射线检测方法，将结果存放在 <code>m_Hits</code> 中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m_Hits = ReflectionMethodsCache.Singleton.raycast3DAll(ray, distanceToClipPlane, finalEventMask);</span><br></pre></td></tr></table></figure>
<p>但 <code>m_Hits</code> 本身为 <code>RaycastHit[]</code> 类型，想要在 <code>EventSystem</code> 中使用，还需要将其转换为 <code>RaycastResult</code> 类型。这里会遍历 <code>m_Hits</code>，将每一个 <code>RaycastHit</code> 转换为 <code>RaycastResult</code>，并添加到 <code>resultAppendList</code> 中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> b = <span class="number">0</span>, bmax = hitCount; b &lt; bmax; ++b)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">new</span> RaycastResult</span><br><span class="line">    &#123;</span><br><span class="line">        gameObject = m_Hits[b].collider.gameObject,</span><br><span class="line">        module = <span class="keyword">this</span>,</span><br><span class="line">        distance = m_Hits[b].distance,</span><br><span class="line">        worldPosition = m_Hits[b].point,</span><br><span class="line">        worldNormal = m_Hits[b].normal,</span><br><span class="line">        screenPosition = eventData.position,</span><br><span class="line">        index = resultAppendList.Count,</span><br><span class="line">        sortingLayer = <span class="number">0</span>,</span><br><span class="line">        sortingOrder = <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    resultAppendList.Add(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，<code>PhysicsRaycaster</code> 类就完成了一次射线检测的过程。</p>
<h3 id="小结-3">小结</h3>
<p><img src="https://s2.loli.net/2024/08/29/HecZgtjClOodzEv.png" alt="image.png"></p>
<p>至此，我们就分析完了射线检测模块的相关内容。总体而言，射线检测模块主要用于检测当前鼠标位置下的物体，以及获取该次射线检测的相关信息。<code>RaycastResult</code> 类用于存放射线检测的结果，<code>RaycasterManager</code> 类用于管理所有的射线检测器，<code>ReflectionMethodsCache</code> 类用于通过反射获取射线检测函数，<code>BaseRaycaster</code> 类是所有射线检测器的基类，定义了射线检测器的基本属性及方法，其中有一个抽象方法 <code>Raycast</code> 用于射线检测。而 <code>PhysicsRaycaster</code> 及 <code>Physics2DRaycaster</code> 类则分别重写了 <code>Raycast</code> 及 <code>eventCamera</code> 方法，用于进行 3D 及 2D 的射线检测。</p>
<h2 id="ExecuteEvents">ExecuteEvents</h2>
<p><code>ExecuteEvents</code> 是 <code>EventSystem</code> 中的最后一部分内容，它的主要功能为执行各种事件，上文中我们多次看到了 <code>ExecuteEvents.Execute</code> 方法，这个方法就是 <code>ExecuteEvents</code> 类中的一个静态方法。<code>ExecuteEvents</code> 类定义了一系列的静态方法，用于执行 <code>EventSystem</code> 中的事件，将事件发送给对应的 <code>GameObject</code>。</p>
<h3 id="EventSystemHandler">EventSystemHandler</h3>
<p><code>EventInterfaces.cs</code> 中定义了 <code>EventSystem</code> 中各类事件的接口，最终事件响应的逻辑需要继承这些接口来书写具体的逻辑。</p>
<p>首先，<code>EventInterfaces</code> 中定义了一个公共的接口 <code>IEventSystemHandler</code>，所有 <code>EventSystem</code> 的事件处理接口均需要继承这个接口。</p>
<p><code>handler</code> 主要分为三种类型：</p>
<ul>
<li>
<p><code>IPointerXXXHandler</code> ： 处理鼠标点击和触屏事件</p>
</li>
<li>
<p><code>IDragXXXXHandler</code>：处理拖拽事件</p>
</li>
<li>
<p><code>IXXXHandler</code>：处理其他如选择、取消等事件</p>
</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPointerXXXHandler</span> : <span class="title">IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Use this callback to detect pointer XXX events</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnPointerXXX</span>(<span class="params">PointerEventData eventData</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IXXXDragHandler</span> : <span class="title">IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Called by a BaseInputModule when a drag is XXX.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnXXXDrag</span>(<span class="params">PointerEventData eventData</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IXXXHandler</span> : <span class="title">IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Use this callback to detect XXX events.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnXXX</span>(<span class="params">PointerEventData eventData</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ExecuteEvents-2">ExecuteEvents</h3>
<h4 id="Handler">Handler</h4>
<p><code>ExecuteEvents</code> 类定义了一系列的静态方法，用于执行事件。这些方法主要用于执行 <code>EventSystem</code> 中的事件，将事件发送给对应的 <code>GameObject</code>。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">EventFunction</span>&lt;<span class="title">T1</span>&gt;(<span class="params">T1 handler, BaseEventData eventData</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">ValidateEventData</span>&lt;<span class="title">T</span>&gt;(<span class="params">BaseEventData data</span>) <span class="keyword">where</span> T : <span class="keyword">class</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((data <span class="keyword">as</span> T) == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(String.Format(<span class="string">&quot;Invalid type: &#123;0&#125; passed to event expecting &#123;1&#125;&quot;</span>, data.GetType(), <span class="keyword">typeof</span>(T)));</span><br><span class="line">    <span class="keyword">return</span> data <span class="keyword">as</span> T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> EventFunction&lt;IPointerEnterHandler&gt; s_PointerEnterHandler = Execute;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">IPointerEnterHandler handler, BaseEventData eventData</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    handler.OnPointerEnter(ValidateEventData&lt;PointerEventData&gt;(eventData));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> EventFunction&lt;IPointerExitHandler&gt; s_PointerExitHandler = Execute;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">IPointerExitHandler handler, BaseEventData eventData</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    handler.OnPointerExit(ValidateEventData&lt;PointerEventData&gt;(eventData));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ...</span></span><br></pre></td></tr></table></figure>
<p>首先，<code>ExecuteEvents</code> 类定义了一个委托 <code>EventFunction&lt;T1&gt;</code>，该委托接受一个 <code>T1</code> 类型的参数 <code>handler</code> 和一个 <code>BaseEventData</code> 类型的参数 <code>eventData</code>，返回 <code>void</code>。 <code>ValidateEventData</code> 方法用于验证 <code>eventData</code> 是否为 <code>T</code> 类型，如果不是则抛出异常。</p>
<p>接着，<code>ExecuteEvents</code> 类定义了一系列的静态方法，用于执行 <code>EventSystem</code> 中不同类型的事件，如 <code>PointerEnter</code>、<code>PointerExit</code> 等。这些方法都是通过委托调用 <code>handler</code> 的对应方法，将 <code>eventData</code> 传递给 <code>handler</code>。</p>
<h4 id="辅助函数">辅助函数</h4>
<p>在分析最重要的 <code>Execute</code> 函数之前，先来看一些相关的辅助函数：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetEventChain</span>(<span class="params">GameObject root, IList&lt;Transform&gt; eventChain</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    eventChain.Clear();</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> t = root.transform;</span><br><span class="line">    <span class="keyword">while</span> (t != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        eventChain.Add(t);</span><br><span class="line">        t = t.parent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>GetEventChain</code> 方法用于获取 <code>GameObject</code> 的事件链。该方法会将 <code>root</code> 的所有父节点添加到 <code>eventChain</code> 中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">ShouldSendToComponent</span>&lt;<span class="title">T</span>&gt;(<span class="params">Component component</span>) <span class="keyword">where</span> T : IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> valid = component <span class="keyword">is</span> T;</span><br><span class="line">    <span class="keyword">if</span> (!valid)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> behaviour = component <span class="keyword">as</span> Behaviour;</span><br><span class="line">    <span class="keyword">if</span> (behaviour != <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> behaviour.isActiveAndEnabled;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ShouldSendToComponent</code> 方法用于判断是否应该发送事件给 <code>Component</code>。该方法会判断 <code>component</code> 是否为 <code>T</code> 类型，以及 <code>component</code> 是否激活。如果满足条件，则返回 <code>true</code>，否则返回 <code>false</code>。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Get the specified object&#x27;s event event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetEventList</span>&lt;<span class="title">T</span>&gt;(<span class="params">GameObject go, IList&lt;IEventSystemHandler&gt; results</span>) <span class="keyword">where</span> T : IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Debug.LogWarning(&quot;GetEventList&lt;&quot; + typeof(T).Name + &quot;&gt;&quot;);</span></span><br><span class="line">    <span class="keyword">if</span> (results == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Results array is null&quot;</span>, <span class="string">&quot;results&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (go == <span class="literal">null</span> || !go.activeInHierarchy)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> components = ListPool&lt;Component&gt;.Get();</span><br><span class="line">    go.GetComponents(components);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; components.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ShouldSendToComponent&lt;T&gt;(components[i]))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Debug.Log(string.Format(&quot;&#123;2&#125; found! On &#123;0&#125;.&#123;1&#125;&quot;, go, s_GetComponentsScratch[i].GetType(), typeof(T)));</span></span><br><span class="line">        results.Add(components[i] <span class="keyword">as</span> IEventSystemHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    ListPool&lt;Component&gt;.Release(components);</span><br><span class="line">    <span class="comment">// Debug.LogWarning(&quot;end GetEventList&lt;&quot; + typeof(T).Name + &quot;&gt;&quot;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>GetEventList</code> 方法用于获取 <code>GameObject</code> 中类型为 <code>T</code> 的所有事件组件。该方法会遍历 <code>go</code> 的所有组件，如果组件为 <code>T</code> 类型且激活，则将其添加到 <code>results</code> 中。</p>
<blockquote>
<p>值得注意的是这里在进行中间的 list 变量处理时，使用了 <code>ListPool</code> 类，这是一个对象池，定义在 <code>Core/Utility/ListPool.cs</code> 中，用于减少内存分配。</p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Whether the specified game object will be able to handle the specified event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CanHandleEvent</span>&lt;<span class="title">T</span>&gt;(<span class="params">GameObject go</span>) <span class="keyword">where</span> T : IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> internalHandlers = s_HandlerListPool.Get();</span><br><span class="line">    GetEventList&lt;T&gt;(go, internalHandlers);</span><br><span class="line">    <span class="keyword">var</span> handlerCount = internalHandlers.Count;</span><br><span class="line">    s_HandlerListPool.Release(internalHandlers);</span><br><span class="line">    <span class="keyword">return</span> handlerCount != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CanHandleEvent</code> 方法用于判断 <code>GameObject</code> 是否能够处理 <code>T</code> 类型的事件。该方法会调用 <code>GetEventList</code> 方法获取 <code>GameObject</code> 中类型为 <code>T</code> 的所有事件组件，如果事件组件的数量不为 0，则返回 <code>true</code>，否则返回 <code>false</code>。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Bubble the specified event on the game object, figuring out which object will actually receive the event.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameObject <span class="title">GetEventHandler</span>&lt;<span class="title">T</span>&gt;(<span class="params">GameObject root</span>) <span class="keyword">where</span> T : IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    Transform t = root.transform;</span><br><span class="line">    <span class="keyword">while</span> (t != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (CanHandleEvent&lt;T&gt;(t.gameObject))</span><br><span class="line">            <span class="keyword">return</span> t.gameObject;</span><br><span class="line">        t = t.parent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>GetEventHandler</code> 方法用于获取 <code>GameObject</code> 中能够处理 <code>T</code> 类型事件的 <strong>第一个</strong> 事件处理器。该方法会遍历 <code>root</code> 的所有父节点，如果父节点能够处理 <code>T</code> 类型事件，则返回该父节点。</p>
<h4 id="Execute-ExecuteHierarchy">Execute &amp; ExecuteHierarchy</h4>
<p>最后，我们来看一下 <code>Execute</code> 方法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Execute</span>&lt;<span class="title">T</span>&gt;(<span class="params">GameObject target, BaseEventData eventData, EventFunction&lt;T&gt; functor</span>) <span class="keyword">where</span> T : IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> internalHandlers = s_HandlerListPool.Get();</span><br><span class="line">    GetEventList&lt;T&gt;(target, internalHandlers);</span><br><span class="line">    <span class="comment">//  if (s_InternalHandlers.Count &gt; 0)</span></span><br><span class="line">    <span class="comment">//      Debug.Log(&quot;Executinng &quot; + typeof (T) + &quot; on &quot; + target);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; internalHandlers.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        T arg;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            arg = (T)internalHandlers[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> temp = internalHandlers[i];</span><br><span class="line">            Debug.LogException(<span class="keyword">new</span> Exception(<span class="built_in">string</span>.Format(<span class="string">&quot;Type &#123;0&#125; expected &#123;1&#125; received.&quot;</span>, <span class="keyword">typeof</span>(T).Name, temp.GetType().Name), e));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            functor(arg, eventData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> handlerCount = internalHandlers.Count;</span><br><span class="line">    s_HandlerListPool.Release(internalHandlers);</span><br><span class="line">    <span class="keyword">return</span> handlerCount &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Execute</code> 方法在 <code>InputModule</code> 部分多次被调用，用于执行 <code>EventSystem</code> 中的不同类型的事件。针对一个特定的输入事件类型 <code>T</code>（如 <code>IPointerEnterHandler</code>、<code>IPointerExitHandler</code> 等），该方法会获取 <code>target</code> 中所有类型为 <code>T</code> 的事件组件，并调用 <code>functor</code> 方法，将 <code>eventData</code> 传递给这些事件组件。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GameObject <span class="title">ExecuteHierarchy</span>&lt;<span class="title">T</span>&gt;(<span class="params">GameObject root, BaseEventData eventData, EventFunction&lt;T&gt; callbackFunction</span>) <span class="keyword">where</span> T : IEventSystemHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    GetEventChain(root, s_InternalTransformList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; s_InternalTransformList.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> transform = s_InternalTransformList[i];</span><br><span class="line">        <span class="keyword">if</span> (Execute(transform.gameObject, eventData, callbackFunction))</span><br><span class="line">            <span class="keyword">return</span> transform.gameObject;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ExecuteHierarchy</code> 方法用于在 <code>root</code> 的事件链中执行 <code>T</code> 类型的事件。该方法会获取 <code>root</code> 的事件链，遍历事件链中的每一个节点，并调用 <code>Execute</code> 方法，将 <code>eventData</code> 传递给这些节点。</p>
<h3 id="小结-4">小结</h3>
<p><img src="https://s2.loli.net/2024/08/29/A2Y96M1zaVelJfR.png" alt="image.png"></p>
<p>至此，我们就分析完了 <code>EventSystem</code> 中的 <code>ExecuteEvents</code> 部分。总体而言，<code>ExecuteEvents</code> 类定义了一系列的静态方法，用于执行 <code>EventSystem</code> 中的事件。这些方法主要用于处理不同类型的 <code>EventSystem</code> 中的事件，并将事件发送给对应的 <code>GameObject</code>。<code>ExecuteEvents</code> 类中定义了一系列的辅助函数，用于获取 <code>GameObject</code> 的事件链、获取 <code>GameObject</code> 中类型为 <code>T</code> 的所有事件组件、判断 <code>GameObject</code> 是否能够处理 <code>T</code> 类型事件等；同时，<code>ExecuteEvents</code> 类中定义了 <code>Execute</code> 及 <code>ExecuteHierarchy</code> 方法，用于执行 <code>EventSystem</code> 中的不同类型的事件。<code>InputModule</code> 中主要就是通过这些方法来执行 <code>EventSystem</code> 中的事件。</p>
<h1>总结</h1>
<p><img src="https://s2.loli.net/2024/08/27/fY5XunWKbGVLv3S.png" alt="image.png"></p>
<p>至此，我们就分析完了整个 <code>EventSystem</code> 的实现。<code>EventSystem</code> 是 UGUI 系统中的一个核心组件，用于管理和处理用户输入事件。它是所有 UI 交互的基础，负责检测和分发输入事件，如鼠标点击、触摸、键盘输入等。<code>EventSystem</code> 的主要功能包括：</p>
<ol>
<li>
<p>管理所有的输入检测模块（<code>InputModule</code>）。 <code>EventSystem</code> 使用输入模块（Input Modules）来处理不同类型的输入并逐帧调用 Module 的执行函数 <code>Process()</code>，常见的输入模块包括 <code>StandaloneInputModule</code>（用于鼠标和键盘输入）和 <code>TouchInputModule</code>（用于触摸输入）。</p>
</li>
<li>
<p>调动射线捕捉模块（<code>Raycasters</code>），为 <code>InputModule</code> 提供结果（具体的触点所穿透的对象信息）。 <code>EventSystem</code> 使用射线检测（Raycasting）来确定用户输入的位置和目标。它会发射一条射线，从输入设备（如鼠标或触摸点）的位置出发，检测与之相交的 UI 元素，并将事件传递给 UI 元素。</p>
</li>
<li>
<p>事件监听及处理（<code>ExecuteEvent</code>）。 <code>EventSystem</code> 会捕获用户的输入事件，生成对应的 <code>EventData</code> 并将这些事件分发给相应的 UI 元素。UI 元素可以通过实现特定的接口（如 <code>IPointerClickHandler</code>、<code>IPointerEnterHandler</code> 等）来监听和处理事件。<code>EventSystem</code> 会根据事件类型调用相应的接口方法。</p>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://qlipphoth.github.io">Qliphoth</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://qlipphoth.github.io/2024/08/27/2024-8-27-1/">https://qlipphoth.github.io/2024/08/27/2024-8-27-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Unity/">Unity</a><a class="post-meta__tags" href="/tags/C/">C#</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/23/2024-8-23-1/" title="C++ 补完计划（七）：RTTI"><img class="cover" src="https://s2.loli.net/2023/08/12/a6FceKmItYSsW7b.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">C++ 补完计划（七）：RTTI</div></div></a></div><div class="next-post pull-right"><a href="/2024/08/29/2024-8-29-1/" title="Unity 补完计划（四）：UGUI-2：IndexedSet"><img class="cover" src="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Unity 补完计划（四）：UGUI-2：IndexedSet</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/08/05/2024-8-5-1/" title="UGUI 源码解析"><img class="cover" src="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-05</div><div class="title">UGUI 源码解析</div></div></a></div><div><a href="/2024/11/03/2024-11-3-1/" title="UGUI 番外之合批"><img class="cover" src="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-03</div><div class="title">UGUI 番外之合批</div></div></a></div><div><a href="/2024/10/25/2024-10-25-2/" title="Unity 补完计划（四）：UGUI-16：Dropdown"><img class="cover" src="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="title">Unity 补完计划（四）：UGUI-16：Dropdown</div></div></a></div><div><a href="/2024/10/25/2024-10-25-1/" title="Unity 补完计划（四）：UGUI-15：ScrollBar &amp; ScrollRect"><img class="cover" src="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-25</div><div class="title">Unity 补完计划（四）：UGUI-15：ScrollBar &amp; ScrollRect</div></div></a></div><div><a href="/2024/10/23/2024-10-23-1/" title="Unity 补完计划（四）：UGUI-14：InputField"><img class="cover" src="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-23</div><div class="title">Unity 补完计划（四）：UGUI-14：InputField</div></div></a></div><div><a href="/2024/10/17/2024-10-17-1/" title="Unity 补完计划（四）：UGUI-13：Toggle &amp; ToggleGroup &amp; Slider"><img class="cover" src="https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-17</div><div class="title">Unity 补完计划（四）：UGUI-13：Toggle &amp; ToggleGroup &amp; Slider</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2023/08/12/NkcT1PLmZVj5iY3.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Qliphoth</div><div class="author-info__description">See You Next Game</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">131</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">22</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qlipphoth"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/qlipphoth" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://space.bilibili.com/33030427" target="_blank" title="Bilibili"><i class="fab fa-bilibili" style="color: #FB7299;"></i></a><a class="social-icon" href="mailto:1841362281@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">EventSystem</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#EventSystem"><span class="toc-number">1.1.</span> <span class="toc-text">EventSystem</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.1.1.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InputModule"><span class="toc-number">1.2.</span> <span class="toc-text">InputModule</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BaseInput"><span class="toc-number">1.2.1.</span> <span class="toc-text">BaseInput</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventData"><span class="toc-number">1.2.2.</span> <span class="toc-text">EventData</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BaseInputModule"><span class="toc-number">1.2.3.</span> <span class="toc-text">BaseInputModule</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PointerInputModule"><span class="toc-number">1.2.4.</span> <span class="toc-text">PointerInputModule</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GetTouchPointerEventData"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">GetTouchPointerEventData</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GetMousePointerEventData"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">GetMousePointerEventData</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StandaloneInputModule"><span class="toc-number">1.2.5.</span> <span class="toc-text">StandaloneInputModule</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UpdateModule"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">UpdateModule</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Process"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">Process</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ProcessTouchEvents"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">ProcessTouchEvents</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ProcessMouseEvent"><span class="toc-number">1.2.5.4.</span> <span class="toc-text">ProcessMouseEvent</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="toc-number">1.2.6.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Raycasters"><span class="toc-number">1.3.</span> <span class="toc-text">Raycasters</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RaycastResult"><span class="toc-number">1.3.1.</span> <span class="toc-text">RaycastResult</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RaycasterManager"><span class="toc-number">1.3.2.</span> <span class="toc-text">RaycasterManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReflectionMethodsCache"><span class="toc-number">1.3.3.</span> <span class="toc-text">ReflectionMethodsCache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BaseRaycaster-PhysicsRaycaster-Physics2DRaycaster"><span class="toc-number">1.3.4.</span> <span class="toc-text">BaseRaycaster &#x2F; PhysicsRaycaster &#x2F; Physics2DRaycaster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-3"><span class="toc-number">1.3.5.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ExecuteEvents"><span class="toc-number">1.4.</span> <span class="toc-text">ExecuteEvents</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EventSystemHandler"><span class="toc-number">1.4.1.</span> <span class="toc-text">EventSystemHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ExecuteEvents-2"><span class="toc-number">1.4.2.</span> <span class="toc-text">ExecuteEvents</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Handler"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">Handler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">辅助函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Execute-ExecuteHierarchy"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">Execute &amp; ExecuteHierarchy</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-4"><span class="toc-number">1.4.3.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/12/10/2024-12-10-1/" title="TortoiseSVN 简单入门"><img src="https://s2.loli.net/2023/08/14/mkTFOD8fJbu4VH3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="TortoiseSVN 简单入门"/></a><div class="content"><a class="title" href="/2024/12/10/2024-12-10-1/" title="TortoiseSVN 简单入门">TortoiseSVN 简单入门</a><time datetime="2024-12-10T17:21:06.000Z" title="Created 2024-12-10 17:21:06">2024-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/23/2024-11-23-1/" title="Lua 源码解析（二）：基本数据类型 —— 表（下）"><img src="https://s2.loli.net/2024/11/08/NRtroieCAd98Uzp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Lua 源码解析（二）：基本数据类型 —— 表（下）"/></a><div class="content"><a class="title" href="/2024/11/23/2024-11-23-1/" title="Lua 源码解析（二）：基本数据类型 —— 表（下）">Lua 源码解析（二）：基本数据类型 —— 表（下）</a><time datetime="2024-11-23T16:58:19.000Z" title="Created 2024-11-23 16:58:19">2024-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/17/2024-11-17-1/" title="Lua 源码解析（二）：基本数据类型 —— 表（上）"><img src="https://s2.loli.net/2024/11/08/NRtroieCAd98Uzp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Lua 源码解析（二）：基本数据类型 —— 表（上）"/></a><div class="content"><a class="title" href="/2024/11/17/2024-11-17-1/" title="Lua 源码解析（二）：基本数据类型 —— 表（上）">Lua 源码解析（二）：基本数据类型 —— 表（上）</a><time datetime="2024-11-17T16:36:15.000Z" title="Created 2024-11-17 16:36:15">2024-11-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/15/2024-11-15-1/" title="Lua 源码解析（二）：基本数据类型 —— 字符串"><img src="https://s2.loli.net/2024/11/08/NRtroieCAd98Uzp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Lua 源码解析（二）：基本数据类型 —— 字符串"/></a><div class="content"><a class="title" href="/2024/11/15/2024-11-15-1/" title="Lua 源码解析（二）：基本数据类型 —— 字符串">Lua 源码解析（二）：基本数据类型 —— 字符串</a><time datetime="2024-11-15T16:09:05.000Z" title="Created 2024-11-15 16:09:05">2024-11-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/14/2024-11-14-1/" title="Lua 源码解析（二）：基本数据类型 —— Lua 中的数据类型"><img src="https://s2.loli.net/2024/11/08/NRtroieCAd98Uzp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Lua 源码解析（二）：基本数据类型 —— Lua 中的数据类型"/></a><div class="content"><a class="title" href="/2024/11/14/2024-11-14-1/" title="Lua 源码解析（二）：基本数据类型 —— Lua 中的数据类型">Lua 源码解析（二）：基本数据类型 —— Lua 中的数据类型</a><time datetime="2024-11-14T15:28:37.000Z" title="Created 2024-11-14 15:28:37">2024-11-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2024/07/14/2wNJafA1kFbesZy.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By Qliphoth</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://qliphoth.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://qliphoth.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.textContent = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[image]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[link]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[code]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://qliphoth.netlify.app/.netlify/functions/twikoo',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "Unable to get the data, please make sure the settings are correct."
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'No Comment'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="8654234284" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"> </div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://hexo-api-khaki.vercel.app/api/?user=qlipphoth";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="qlipphoth";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/'){
                console.log("已挂载hexo-github-calendar https://github.com/Barry-Flynn/hexo-github-calendar");
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><script data-pjax>function electric_clock_injector_config(){
                var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
                var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img id="card-clock-loading" src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-clock/clock/images/weather/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading" class="entered loading"></div></div></div></div></div>';
                console.log('已挂载electric_clock')
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementsByClassName('sticky_layout')[0] && (location.pathname ==='/'|| '/' ==='all')){

            electric_clock_injector_config()
        } </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax  src="https://cdn.jsdelivr.net/gh/Zfour/hexo-electric-clock@1.0.6/clock.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><div id="ghbdages" style="overflow:hidden;max-height:90px;height:auto;text-align:center;margin-top:10px"><div class="swiper-wrapper"><div class="swiper-slide"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v5.4.0"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v3.8.2"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></div></div></div><style>a.github-badge:hover:before {display:none}</style>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime.js"></script><script defer src="https://unpkg.zhimg.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://unpkg.zhimg.com/hexo-butterfly-footer-beautify/lib/swiperbdage_init.min.js"></script><!-- hexo injector body_end end --></body></html>